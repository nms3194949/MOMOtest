<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MOMO權證篩選器 (GitHub 版)</title>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/cpexcel.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --deep:#0A1221; --card:#0C152A;
    --gold-grad:linear-gradient(90deg,#F9E27C 0%,#D9B84B 50%,#B88A1E 100%);
    --gold-soft:#E9D18A; --gold-solid:#E5C45A;
    --line:#E9D18A55; --muted:#9fb0d0; --red:#FF6B6B;
  }
  html,body{ margin:0;background:var(--deep);color:#fff;font-family:"Noto Sans TC",sans-serif; }
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .field{flex:1 1 220px;background:#0b1630;color:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px;outline:none;}
  .btn-link{background:var(--gold-grad);color:#000;border:none;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer;white-space:nowrap}
  .btn-link:hover{opacity:0.9}
  .btn-link[disabled]{opacity:.6;cursor:not-allowed}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:13px;border:1px solid var(--line)}
  th,td{border:1px solid var(--line);padding:8px;text-align:left;white-space:nowrap}
  th{position:sticky;top:0;background:#0f1b34;color:var(--gold-soft)}
  .tag{padding:2px 8px;border-radius:999px;font-size:11px;font-weight:600}
  .tag.C{background:#E25A5A} .tag.P{background:#39C27A}
  .gold-text{background:var(--gold-grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:700}
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h3>MOMO權證篩選器 (GitHub 版)</h3>
    <p id="meta" style="font-size:12px;color:var(--muted)">請先設定 GAS 網址後點擊「下載權證資料」。</p>
    <div class="row">
      <button id="btnFetch" class="btn-link">下載權證資料</button>
      <input id="nameFilter" type="text" class="field" placeholder="關鍵字篩選..."/>
      <select id="selType" class="field" style="max-width:120px">
        <option value="C" selected>認購 (C)</option>
        <option value="P">認售 (P)</option>
      </select>
      <select id="selLimit" class="field" style="max-width:120px">
        <option value="10" selected>顯示 10 列</option>
        <option value="all">顯示全部</option>
      </select>
      <button id="btnExportPng" class="btn-link">匯出 PNG</button>
    </div>
  </div>

  <div id="resultCard" class="card" style="margin-top:12px;display:none">
    <div id="resultScroll" style="overflow:auto;max-height:70vh">
      <table id="resultTable">
        <thead>
          <tr><th>代號</th><th>名稱</th><th>類型</th><th>價差比</th><th>槓桿</th><th>S1</th><th>天數</th><th>履約價</th><th>隱波</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* --- 配置區 --- */
const GAS_URL = "https://script.google.com/macros/s/AKfycbwGUgr8LFnjZDSCT5qDZ0lpD0o8c2ztVdAwCsmI2kHRqR3ZvofkT6BLoJpJLe-fTOrO/exec"; 

/* --- 核心邏輯 --- */
const $=s=>document.querySelector(s);
let RAW=[];

// API 抓取
$("#btnFetch").addEventListener("click", async () => {
  if(GAS_URL.includes("在此貼入")) return alert("請先在程式碼中設定 GAS_URL！");
  
  const btn = $("#btnFetch");
  btn.disabled = true; btn.textContent = "資料載入中...";

  try {
    // 呼叫 GAS (GET 請求)
    const res = await fetch(GAS_URL);
    if(!res.ok) throw new Error("API 回應異常");
    const csv = await res.text();

    const wb = XLSX.read(csv, { type:"string", codepage:65001 });
    const arr = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    
    RAW = arr.map(processRow);
    render();
    $("#meta").textContent = `更新成功！共 ${RAW.length} 筆資料。`;
  } catch (e) {
    alert("失敗: " + e.message);
  } finally {
    btn.disabled = false; btn.textContent = "下載權證資料";
  }
});

function processRow(r) {
  // 對應元大欄位名稱
  const name = r["FLD_WAR_NM"] || "";
  const spread = parseFloat(r["買賣價差比"]) || 0;
  const lev = Math.abs(parseFloat(r["FLD_LEVERAGE"])) || 1;
  return {
    code: r["FLD_WAR_ID"],
    name: name,
    cp: (/[售]/.test(name) || /P/.test(name)) ? "P" : "C",
    spread: spread,
    leverage: lev,
    s1: spread / lev,
    days: r["FLD_PERIOD"],
    strike: r["FLD_N_STRIKE_PRC"],
    iv: r["FLD_IV_CLOSE_PRICE"]
  };
}

function render() {
  const want = $("#selType").value;
  const limit = $("#selLimit").value === "all" ? RAW.length : parseInt($("#selLimit").value);
  const filterText = $("#nameFilter").value.toLowerCase();

  const filtered = RAW.filter(r => r.cp === want && r.name.toLowerCase().includes(filterText));
  filtered.sort((a,b) => a.s1 - b.s1);

  const tb = $("#tbody");
  tb.innerHTML = "";
  filtered.slice(0, limit).forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.code}</td>
      <td>${r.name}</td>
      <td><span class="tag ${r.cp}">${r.cp}</span></td>
      <td>${r.spread.toFixed(3)}</td>
      <td>${r.leverage.toFixed(2)}</td>
      <td class="${r.s1 < 0.1 ? 'gold-text' : ''}">${(r.s1 * 100).toFixed(2)}%</td>
      <td>${r.days}</td>
      <td>${r.strike}</td>
      <td>${r.iv}</td>
    `;
    tb.appendChild(tr);
  });
  $("#resultCard").style.display = "block";
}

["selType", "selLimit", "nameFilter"].forEach(id => $(`#${id}`).addEventListener("change", render));
$("#btnExportPng").addEventListener("click", async () => {
  const canvas = await html2canvas($("#resultCard"), { backgroundColor: "#0A1221" });
  const a = document.createElement("a");
  a.href = canvas.toDataURL(); a.download = "warrant.png"; a.click();
});
</script>
</body>
</html>
