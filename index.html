<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ¥µé€Ÿç´”å‰ç«¯ RAGï¼ˆå–®æª”ç‰ˆï½œLEDï¼‹é€²åº¦ï½œTF-IDFï¼‰</title>
<style>
  :root{
    --deep:#0A1221; --gold:#C9A227; --ink:#e7ecf3; --muted:#a8b3c7;
    --card:#0C152A; --line:rgba(233,209,138,.28);
    --ok:#39C27A; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--deep);color:var(--ink);font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .kv{background:#0b1226;border:1px solid var(--line);padding:8px 10px;border-radius:10px}
  .progress{height:12px;border-radius:999px;background:#0b1226;border:1px solid var(--line);overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,#C9A227,#E9D18A);width:0%}
  .subprogress{height:8px;border-radius:999px;background:#0b1226;border:1px solid var(--line);overflow:hidden}
  .subbar{height:100%;background:linear-gradient(90deg,#6EE7B7,#34D399);width:0%}
  .btn{padding:10px 14px;border:1px solid var(--gold);border-radius:12px;background:transparent;color:var(--ink);cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  input,textarea,select{background:#0b1226;border:1px solid var(--line);border-radius:12px;color:var(--ink);padding:10px}
  textarea{width:100%;min-height:120px}
  .answer{white-space:pre-wrap;line-height:1.7}
  .cite{font-size:13px;color:var(--muted)}
  .led{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;border:1px solid rgba(255,255,255,.2)}
  .red{background:var(--bad)} .yellow{background:var(--warn)} .green{background:var(--ok)}
  .steps{display:grid;grid-template-columns:24px 1fr auto;gap:8px;align-items:center;margin-top:8px}
  .step{padding:6px 8px;border:1px dashed var(--line);border-radius:10px}
  .right{justify-self:end;color:var(--muted);font-size:12px}
  code{background:#0b1226;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>âš¡ æ¥µé€Ÿç´”å‰ç«¯æ–‡ä»¶å•ç­”ï¼ˆRAGï¼‰â€” å–®æª”ç‰ˆ</h1>

  <div class="card">
    <div class="row"><strong>åˆå§‹åŒ–</strong><span id="status" class="muted">å°šæœªé–‹å§‹</span></div>
    <div class="row" style="margin-top:8px">
      <div class="progress" style="flex:1;min-width:240px"><div id="bar" class="bar"></div></div>
      <span id="pct" class="kv">0%</span>
      <span id="meta" class="kv">â€”</span>
    </div>
    <div class="steps">
      <span class="led red" id="led1"></span><div class="step">1) è¼‰å…¥å…§åµŒè³‡æ–™ï¼æˆ–æº–å‚™æŠ½å–</div><div class="right" id="t1">â€”</div>
      <span class="led red" id="led2"></span><div class="step">2) å»ºç«‹ TF-IDF ç´¢å¼•ï¼ˆæœ¬æ©Ÿï¼‰</div><div class="right" id="t2">â€”</div>
      <span class="led red" id="led3"></span><div class="step">3) å®Œæˆï¼Œå°±ç·’</div><div class="right" id="t3">â€”</div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="initBtn" class="btn">é–‹å§‹åˆå§‹åŒ–</button>
      <button id="clearBtn" class="btn">é‡ç½®</button>
      <a id="downloadPdf" class="btn" download="document.pdf">ä¸‹è¼‰å…§åµŒ PDF</a>
    </div>
  </div>

  <div class="card">
    <div class="row"><strong>æå•</strong><span class="muted">ç´¢å¼•å®Œæˆå¾Œå³å¯ä½¿ç”¨</span></div>
    <input id="question" type="text" placeholder="ä¾‹å¦‚ï¼šç¶“éŠ·å•†çš„ç”³è«‹åœ¨å“ªè£¡è¨­å®šï¼Ÿ">
    <div class="row" style="margin-top:8px">
      <label>Top-kï¼š<select id="topk"><option>3</option><option selected>5</option><option>7</option><option>10</option></select></label>
      <label>æ¯æ®µå­—æ•¸ä¸Šé™ï¼š<select id="cliplen"><option>200</option><option selected>360</option><option>500</option></select></label>
      <button id="askBtn" class="btn" disabled>é€å‡ºå•é¡Œ</button>
    </div>
    <div id="answer" class="answer" style="margin-top:10px">ï¼ˆå°šç„¡å›ç­”ï¼‰</div>
    <div id="cites" class="cite"></div>
  </div>

  <div class="card">
    <details>
      <summary>ğŸ“ å…§åµŒè³‡æ–™è¨­å®šï¼ˆå¯æŠ˜ç–Šï¼‰</summary>
      <p class="muted">äºŒé¸ä¸€ï¼š<br>1) ç›´æ¥è²¼ä¸Š <b>è³‡æ–™é›† JSON</b>ï¼ˆé–‹é å³ç”¨ï¼Œæœ€å¿«ï¼‰<br>2) åƒ…è²¼ <b>PDF base64</b>ï¼Œå†æŒ‰ã€ŒæŠ½å– PDFã€â†’ ç”±é é¢æŠ½å–ä¸¦å»ºç´¢å¼•ï¼ˆè¼ƒæ…¢ï¼‰</p>
      <h4>1) å…§åµŒè³‡æ–™é›†ï¼ˆå¯é¸ï¼‰</h4>
      <textarea id="datasetBox" placeholder='è²¼ä¸Šä½ é å…ˆç®—å¥½çš„ DATASETï¼ˆæ ¼å¼è¦‹ä¸‹æ–¹ç¨‹å¼å€å¡Šèªªæ˜ï¼‰ã€‚ç•™ç©ºè¡¨ç¤ºæ”¹èµ°ã€ŒæŠ½å– PDFã€æ¨¡å¼ã€‚'></textarea>
      <h4>2) å…§åµŒ PDF base64ï¼ˆå¯é¸ï¼‰</h4>
      <textarea id="pdfBox" placeholder='è²¼ä¸Šä½ çš„ PDF base64ï¼ˆä¾‹å¦‚ï¼šbase64 -i ä½ çš„.pdfï¼‰ã€‚'></textarea>
      <div class="row" style="margin-top:8px">
        <button id="extractBtn" class="btn">æŠ½å– PDFï¼ˆç”¨ base64 â†’ æ–‡å­— â†’ åˆ†å¡Š â†’ å»ºç´¢å¼•ï¼‰</button>
      </div>
    </details>
  </div>

  <details class="card">
    <summary>ğŸ”§ é™¤éŒ¯è³‡è¨Š</summary>
    <pre id="log" style="white-space:pre-wrap;font-size:12px;color:#a1a1aa"></pre>
  </details>
</div>

<script>
/* ========== ä½ å¯ä»¥ç›´æ¥åœ¨ä¸‹æ–¹å…©å€‹è®Šæ•¸å…§ã€Œé å…ˆè²¼å¥½å…§å®¹ã€ï¼š ========== */
/* === å…§åµŒè³‡æ–™é›†ï¼ˆå¯é¸ï¼‰===
æ ¼å¼ï¼š
{
  "doc": "è¯ç›Ÿè¡ŒéŠ·åŠŸèƒ½èªªæ˜.pdf",
  "createdAt": 1730000000000,
  "pages": [{"page":1,"len":1234}, ...],
  "chunks": [{"id":"1-0","doc":"...","page":1,"text":"..."}, ...]
}
*/
const EMBEDDED_DATASET = null; // â† è‹¥æœ‰é å…ˆç®—å¥½çš„è³‡æ–™ï¼Œç›´æ¥æ”¾ç‰©ä»¶ï¼ˆä¸æ˜¯å­—ä¸²ï¼‰ã€‚å¦å‰‡ä¿æŒ nullã€‚

/* === å…§åµŒ PDF base64ï¼ˆå¯é¸ï¼‰=== */
const PDF_B64 = ""; // â† æŠŠä½ çš„ PDF è½‰æˆ base64ï¼Œæ•´æ®µè²¼é€²å­—ä¸²ï¼ˆç„¡éœ€ data: å‰ç¶´ï¼‰

/* ========== UI/å·¥å…· ========== */
const $status = document.getElementById("status");
const $bar = document.getElementById("bar");
const $pct = document.getElementById("pct");
const $meta = document.getElementById("meta");
const $askBtn = document.getElementById("askBtn");
const $answer = document.getElementById("answer");
const $cites = document.getElementById("cites");
const $q = document.getElementById("question");
const $topk = document.getElementById("topk");
const $cliplen = document.getElementById("cliplen");
const $log = document.getElementById("log");
const leds = [1,2,3].map(i=>document.getElementById("led"+i));
const ts = [1,2,3].map(i=>document.getElementById("t"+i));
const $datasetBox = document.getElementById("datasetBox");
const $pdfBox = document.getElementById("pdfBox");
const $extractBtn = document.getElementById("extractBtn");
const $initBtn = document.getElementById("initBtn");
const $clearBtn = document.getElementById("clearBtn");
const $downloadPdf = document.getElementById("downloadPdf");

function log(s){ $log.textContent += new Date().toLocaleTimeString()+"  "+s+"\n"; }
function bar(p){ $bar.style.width = p+"%"; $pct.textContent = Math.round(p)+"%"; }
function setLed(i,color){ leds[i-1].className = "led " + color; }
function setTxt(i,txt){ ts[i-1].textContent = txt; }
function clip(t,n){ return t.length>n ? (t.slice(0,n)+'â€¦') : t; }
function normalize(s){ return (s||"").replace(/\s+/g," ").trim(); }
function tokenize(s){ return (s.toLowerCase().match(/[a-z0-9\u4e00-\u9fa5]+/g) || []); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ========== TF-IDF ========== */
function tfidfBuild(chunks, onProgress){
  const N = chunks.length;
  const tokenized = new Array(N);
  const df = new Map();
  for (let i=0;i<N;i++){
    const toks = tokenize(chunks[i].text);
    tokenized[i] = toks;
    const uniq = new Set(toks);
    uniq.forEach(t => df.set(t, (df.get(t)||0)+1));
    if (onProgress && i%10===0) onProgress(40 + Math.floor((i/N)*30));
  }
  const idf = new Map(); df.forEach((v,k)=> idf.set(k, Math.log((N+1)/(v+1))+1) );
  return { tokenized, idf, chunks };
}
function tfidfVector(toks, idf){
  const tf = new Map();
  toks.forEach(t => tf.set(t, (tf.get(t)||0)+1));
  const vec = new Map();
  tf.forEach((f,t)=> vec.set(t, f * (idf.get(t)||0)) );
  return vec;
}
function dotMap(a,b){ let s=0; if (a.size>b.size){ const tmp=a; a=b; b=tmp; } a.forEach((va,k)=>{ const vb=b.get(k)||0; s+=va*vb; }); return s; }
function normMap(a){ let s=0; a.forEach(v=>s+=v*v); return Math.sqrt(s); }
function cosineMap(a,b){ return dotMap(a,b)/(normMap(a)*normMap(b)+1e-12); }

/* ========== PDF æ–‡å­—æŠ½å–ï¼ˆç´”å‰ç«¯ï¼‰ ==========
   èªªæ˜ï¼šä¸ä½¿ç”¨ pdf.jsï¼›é€™è£¡æä¾›æ¥µç°¡æ–¹æ¡ˆï¼Œåªå°å«æ–‡å­—çš„ PDF æœ‰æ•ˆã€‚
   è‹¥ PDF ä»¥å‘é‡æˆ–åœ–ç‰‡ç‚ºä¸»ï¼Œå»ºè­°æ”¹èµ°ã€Œé å…ˆæŠ½å–ä¸¦è²¼å…¥ DATASETã€çš„è·¯å¾‘ã€‚
   ï¼ˆé€™æ®µæ–¹æ³•å°å¤šæ•¸ç”± Word/Google Docs è½‰å‡ºä¹‹ PDF ä»å¯æŠ½åˆ°æ–‡å­—ã€‚ï¼‰
*/
async function naiveExtractTextFromPDF(b64){
  try{
    // å˜—è©¦è§£æ PDF çš„æ–‡å­—ç‰©ä»¶ï¼ˆéå¸¸ç°¡åŒ–ï¼Œéå®Œæ•´ PDF è§£ç¢¼ï¼‰
    // ä½œæ³•ï¼šæŠŠ base64 â†’ Uint8Array â†’ ä»¥å­—ä¸²æƒæå¸¸è¦‹çš„æ–‡å­—ç‰‡æ®µï¼ˆTJ / Tjï¼‰
    const bin = atob(b64);
    const maybeText = [];
    // å°‡å¯èƒ½çš„å¯è¦–å­—å…ƒæŠ½å‡ºï¼ˆé¿å…äºŒé€²ä½é€ æˆæ•ˆèƒ½å•é¡Œï¼‰
    for (let i=0;i<bin.length;i++){
      const c = bin.charCodeAt(i);
      if (c===10 || c===13 || (c>=32 && c<=126) || (c>=0x80)) {
        maybeText.push(bin[i]);
      } else {
        maybeText.push(' ');
      }
    }
    const s = maybeText.join('');
    // å¸¸è¦‹ PDF å­—ä¸²æ–‡å­—å¯«æ³•ï¼š(...)Tj / [(...)]TJ
    const regex = /\(([^)]{1,2000})\)\s*Tj|\[\s*(?:\([^)]+\)\s*\d+\s*)+\]\s*TJ/g;
    const parts = [];
    let m;
    while ((m = regex.exec(s)) !== null){
      const grp = m[1] || "";
      if (grp) parts.push(grp.replace(/\\([nrtbf()\\/])/g, '$1')); // åæ–œç·šè½‰ç¾©é‚„åŸ
      if (parts.length % 200 === 0) await sleep(1);
    }
    const textJoined = normalize(parts.join(' '));
    if (!textJoined) throw new Error("æœªèƒ½å¾ PDF æŠ½åˆ°æ–‡å­—ï¼›æ­¤æª”å¯èƒ½æ˜¯æƒææˆ–åœ–åƒç‚ºä¸»ã€‚");
    // ç²—ç•¥åˆ†é ï¼ˆä»¥å¸¸è¦‹ 'Page ' or '/Type /Page' å‡ºç¾æ•¸ä¼°è¨ˆï¼‰ï¼Œæ­¤ç‚ºè¿‘ä¼¼
    const pageCount = Math.max(1, (s.match(/\/Type\s*\/Page/g)||[]).length);
    const perPageLen = Math.ceil(textJoined.length / pageCount);
    const pages = [];
    for (let i=0;i<pageCount;i++){
      pages.push({page: i+1, text: textJoined.slice(i*perPageLen, (i+1)*perPageLen)});
    }
    return { pages, textJoined };
  }catch(e){
    throw e;
  }
}

function chunkPages(pages, chunkChars=900, overlap=150){
  const out = [];
  for (const p of pages){
    const t = normalize(p.text);
    if (!t) continue;
    let i=0, L=t.length;
    while (i<L){
      const end = Math.min(L, i+chunkChars);
      out.push({ id: `${p.page}-${i}`, doc: CURRENT_DOC, page: p.page, text: t.slice(i,end) });
      i = end - overlap; if (i<0) i=0; if (i>=L) break;
    }
  }
  return out;
}

/* ========== ç‹€æ…‹ ========== */
let INDEX = null;
let CURRENT_DOC = "document.pdf";

/* ========== åˆå§‹åŒ–æµç¨‹ ========== */
async function initialize({dataset, pdfb64}){
  try{
    setLed(1,"yellow"); setTxt(1,"æº–å‚™ä¸­â€¦"); bar(10);
    if (dataset && Array.isArray(dataset.chunks) && dataset.chunks.length){
      // èµ°å·²åµŒå…¥è³‡æ–™é›†ï¼ˆæœ€å¿«ï¼‰
      CURRENT_DOC = dataset.doc || CURRENT_DOC;
      $meta.textContent = `æ®µè½ ${dataset.chunks.length}ï½œé æ•¸ ${dataset.pages?.length ?? "â€”"}`;
      setLed(1,"green"); setTxt(1,"è¼‰å…¥å…§åµŒè³‡æ–™ OK"); bar(25);
      setLed(2,"yellow"); setTxt(2,"å»ºç«‹ TF-IDF ä¸­â€¦");
      INDEX = tfidfBuild(dataset.chunks, p => bar(p));
      setLed(2,"green"); setTxt(2,"ç´¢å¼• OK"); bar(90);
    } else if (pdfb64) {
      // èµ° PDF æŠ½å–
      setTxt(1,"æŠ½å– PDF æ–‡å­—â€¦"); bar(20);
      const { pages } = await naiveExtractTextFromPDF(pdfb64);
      if (!pages || !pages.length) throw new Error("æŠ½å–å¤±æ•—ï¼šæ²’æœ‰æ–‡å­—å¯ç”¨ã€‚");
      CURRENT_DOC = "åµŒå…¥ PDF";
      setTxt(1, `æŠ½å–é é¢ ${pages.length} å®Œæˆ`); bar(35);

      setLed(2,"yellow"); setTxt(2,"åˆ†å¡Šï¼†å»ºç´¢å¼•â€¦");
      const chunks = chunkPages(pages, 900, 150);
      $meta.textContent = `æ®µè½ ${chunks.length}ï½œé æ•¸ ${pages.length}`;
      INDEX = tfidfBuild(chunks, p => bar(p));
      setLed(2,"green"); setTxt(2,"ç´¢å¼• OK"); bar(90);
    } else {
      throw new Error("æ²’æœ‰è³‡æ–™å¯ç”¨ï¼šè«‹è²¼ DATASET æˆ– PDF base64ã€‚");
    }

    setLed(3,"green"); setTxt(3,"å°±ç·’"); bar(100);
    $status.textContent = "å®Œæˆï¼Œå¯ä»¥é–‹å§‹æå•ã€‚";
    $askBtn.disabled = false;
  }catch(e){
    $status.textContent = "åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message;
    log("INIT ERROR: " + (e.stack || e.message));
  }
}

/* ========== å•ç­” ========== */
document.getElementById("askBtn").onclick = () => {
  const q = $q.value.trim();
  if (!q) return alert("è«‹è¼¸å…¥å•é¡Œ");
  if (!INDEX) return alert("ç´¢å¼•å°šæœªå»ºç«‹");

  const toks = tokenize(q);
  const qv = tfidfVector(toks, INDEX.idf);
  const scored = INDEX.chunks.map((c, i) => ({ ...c, score: cosineMap(qv, tfidfVector(INDEX.tokenized[i], INDEX.idf)) }))
                             .sort((a,b)=> b.score - a.score);

  const k = parseInt($topk.value,10)||5;
  const clipLen = parseInt($cliplen.value,10)||360;
  const top = scored.slice(0,k);

  const bullets = top.map(t => "â€¢ " + clip(t.text.trim(), clipLen) + ` (p.${t.page}ï¼Œ${t.doc})`);
  $answer.textContent = ["ã€é‡é»æ‘˜éŒ„å›ç­”ã€‘", bullets.join("\n")].join("\n");

  const cites = []; const seen = new Set();
  for (const t of top){
    const key = t.doc+"#"+t.page;
    if(!seen.has(key)){
      seen.add(key);
      cites.push(`<li><code>${t.doc}</code>ï¼ç¬¬ <b>${t.page}</b> é ï¼ˆç›¸ä¼¼åº¦ ${t.score.toFixed(3)}ï¼‰</li>`);
    }
  }
  $cites.innerHTML = cites.length ? `<ol>${cites.join("")}</ol>` : "";
};

/* ========== äº‹ä»¶ç¹«çµ ========== */
$initBtn.onclick = async ()=>{
  $status.textContent = "é–‹å§‹åˆå§‹åŒ–â€¦";
  bar(0); setLed(1,"red"); setLed(2,"red"); setLed(3,"red");
  // å„ªå…ˆé †åºï¼š1) å…§åµŒç‰©ä»¶ EMBEDDED_DATASETï¼›2) textarea datasetï¼›3) å…§åµŒ PDF_B64ï¼›4) textarea pdf
  let ds = EMBEDDED_DATASET;
  if (!ds) {
    try { ds = JSON.parse($datasetBox.value || "null"); } catch { ds = null; }
  }
  let p64 = PDF_B64 || $pdfBox.value.trim();
  // è¨­å®š PDF ä¸‹è¼‰æŒ‰éˆ•
  $downloadPdf.href = p64 ? ("data:application/pdf;base64," + p64) : "data:application/pdf;base64,";
  await initialize({dataset: ds, pdfb64: p64 || null});
};

$extractBtn.onclick = async ()=>{
  // å¿«é€Ÿè·¯ï¼šåªè²¼ PDF base64ï¼Œåœ¨é é¢æŠ½æ–‡å­—ã€å»ºç´¢å¼•
  const p64 = ($pdfBox.value || PDF_B64 || "").trim();
  if (!p64){ alert("è«‹å…ˆè²¼ä¸Š PDF base64"); return; }
  $datasetBox.value = "";
  $status.textContent = "æŠ½å– PDF â†’ åˆ†å¡Š â†’ å»ºç´¢å¼•â€¦";
  bar(0); setLed(1,"red"); setLed(2,"red"); setLed(3,"red");
  // è¨­å®š PDF ä¸‹è¼‰æŒ‰éˆ•
  $downloadPdf.href = "data:application/pdf;base64," + p64;
  await initialize({dataset: null, pdfb64: p64});
};

$clearBtn.onclick = ()=>{
  INDEX = null;
  $status.textContent = "å·²é‡ç½®ã€‚å¯å†æ¬¡åˆå§‹åŒ–ã€‚";
  $answer.textContent = "(å°šç„¡å›ç­”)";
  $cites.innerHTML = "";
  bar(0); setLed(1,"red"); setLed(2,"red"); setLed(3,"red");
};
</script>
</body>
</html>