<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>極速純前端 RAG（單檔版｜LED＋進度｜TF-IDF）</title>
<style>
  :root{
    --deep:#0A1221; --gold:#C9A227; --ink:#e7ecf3; --muted:#a8b3c7;
    --card:#0C152A; --line:rgba(233,209,138,.28);
    --ok:#39C27A; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--deep);color:var(--ink);font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .kv{background:#0b1226;border:1px solid var(--line);padding:8px 10px;border-radius:10px}
  .progress{height:12px;border-radius:999px;background:#0b1226;border:1px solid var(--line);overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,#C9A227,#E9D18A);width:0%}
  .subprogress{height:8px;border-radius:999px;background:#0b1226;border:1px solid var(--line);overflow:hidden}
  .subbar{height:100%;background:linear-gradient(90deg,#6EE7B7,#34D399);width:0%}
  .btn{padding:10px 14px;border:1px solid var(--gold);border-radius:12px;background:transparent;color:var(--ink);cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  input,textarea,select{background:#0b1226;border:1px solid var(--line);border-radius:12px;color:var(--ink);padding:10px}
  textarea{width:100%;min-height:120px}
  .answer{white-space:pre-wrap;line-height:1.7}
  .cite{font-size:13px;color:var(--muted)}
  .led{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;border:1px solid rgba(255,255,255,.2)}
  .red{background:var(--bad)} .yellow{background:var(--warn)} .green{background:var(--ok)}
  .steps{display:grid;grid-template-columns:24px 1fr auto;gap:8px;align-items:center;margin-top:8px}
  .step{padding:6px 8px;border:1px dashed var(--line);border-radius:10px}
  .right{justify-self:end;color:var(--muted);font-size:12px}
  code{background:#0b1226;border:1px solid var(--line);padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>⚡ 極速純前端文件問答（RAG）— 單檔版</h1>

  <div class="card">
    <div class="row"><strong>初始化</strong><span id="status" class="muted">尚未開始</span></div>
    <div class="row" style="margin-top:8px">
      <div class="progress" style="flex:1;min-width:240px"><div id="bar" class="bar"></div></div>
      <span id="pct" class="kv">0%</span>
      <span id="meta" class="kv">—</span>
    </div>
    <div class="steps">
      <span class="led red" id="led1"></span><div class="step">1) 載入內嵌資料／或準備抽取</div><div class="right" id="t1">—</div>
      <span class="led red" id="led2"></span><div class="step">2) 建立 TF-IDF 索引（本機）</div><div class="right" id="t2">—</div>
      <span class="led red" id="led3"></span><div class="step">3) 完成，就緒</div><div class="right" id="t3">—</div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="initBtn" class="btn">開始初始化</button>
      <button id="clearBtn" class="btn">重置</button>
      <a id="downloadPdf" class="btn" download="document.pdf">下載內嵌 PDF</a>
    </div>
  </div>

  <div class="card">
    <div class="row"><strong>提問</strong><span class="muted">索引完成後即可使用</span></div>
    <input id="question" type="text" placeholder="例如：經銷商的申請在哪裡設定？">
    <div class="row" style="margin-top:8px">
      <label>Top-k：<select id="topk"><option>3</option><option selected>5</option><option>7</option><option>10</option></select></label>
      <label>每段字數上限：<select id="cliplen"><option>200</option><option selected>360</option><option>500</option></select></label>
      <button id="askBtn" class="btn" disabled>送出問題</button>
    </div>
    <div id="answer" class="answer" style="margin-top:10px">（尚無回答）</div>
    <div id="cites" class="cite"></div>
  </div>

  <div class="card">
    <details>
      <summary>📎 內嵌資料設定（可折疊）</summary>
      <p class="muted">二選一：<br>1) 直接貼上 <b>資料集 JSON</b>（開頁即用，最快）<br>2) 僅貼 <b>PDF base64</b>，再按「抽取 PDF」→ 由頁面抽取並建索引（較慢）</p>
      <h4>1) 內嵌資料集（可選）</h4>
      <textarea id="datasetBox" placeholder='貼上你預先算好的 DATASET（格式見下方程式區塊說明）。留空表示改走「抽取 PDF」模式。'></textarea>
      <h4>2) 內嵌 PDF base64（可選）</h4>
      <textarea id="pdfBox" placeholder='貼上你的 PDF base64（例如：base64 -i 你的.pdf）。'></textarea>
      <div class="row" style="margin-top:8px">
        <button id="extractBtn" class="btn">抽取 PDF（用 base64 → 文字 → 分塊 → 建索引）</button>
      </div>
    </details>
  </div>

  <details class="card">
    <summary>🔧 除錯資訊</summary>
    <pre id="log" style="white-space:pre-wrap;font-size:12px;color:#a1a1aa"></pre>
  </details>
</div>

<script>
/* ========== 你可以直接在下方兩個變數內「預先貼好內容」： ========== */
/* === 內嵌資料集（可選）===
格式：
{
  "doc": "聯盟行銷功能說明.pdf",
  "createdAt": 1730000000000,
  "pages": [{"page":1,"len":1234}, ...],
  "chunks": [{"id":"1-0","doc":"...","page":1,"text":"..."}, ...]
}
*/
const EMBEDDED_DATASET = null; // ← 若有預先算好的資料，直接放物件（不是字串）。否則保持 null。

/* === 內嵌 PDF base64（可選）=== */
const PDF_B64 = ""; // ← 把你的 PDF 轉成 base64，整段貼進字串（無需 data: 前綴）

/* ========== UI/工具 ========== */
const $status = document.getElementById("status");
const $bar = document.getElementById("bar");
const $pct = document.getElementById("pct");
const $meta = document.getElementById("meta");
const $askBtn = document.getElementById("askBtn");
const $answer = document.getElementById("answer");
const $cites = document.getElementById("cites");
const $q = document.getElementById("question");
const $topk = document.getElementById("topk");
const $cliplen = document.getElementById("cliplen");
const $log = document.getElementById("log");
const leds = [1,2,3].map(i=>document.getElementById("led"+i));
const ts = [1,2,3].map(i=>document.getElementById("t"+i));
const $datasetBox = document.getElementById("datasetBox");
const $pdfBox = document.getElementById("pdfBox");
const $extractBtn = document.getElementById("extractBtn");
const $initBtn = document.getElementById("initBtn");
const $clearBtn = document.getElementById("clearBtn");
const $downloadPdf = document.getElementById("downloadPdf");

function log(s){ $log.textContent += new Date().toLocaleTimeString()+"  "+s+"\n"; }
function bar(p){ $bar.style.width = p+"%"; $pct.textContent = Math.round(p)+"%"; }
function setLed(i,color){ leds[i-1].className = "led " + color; }
function setTxt(i,txt){ ts[i-1].textContent = txt; }
function clip(t,n){ return t.length>n ? (t.slice(0,n)+'…') : t; }
function normalize(s){ return (s||"").replace(/\s+/g," ").trim(); }
function tokenize(s){ return (s.toLowerCase().match(/[a-z0-9\u4e00-\u9fa5]+/g) || []); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* ========== TF-IDF ========== */
function tfidfBuild(chunks, onProgress){
  const N = chunks.length;
  const tokenized = new Array(N);
  const df = new Map();
  for (let i=0;i<N;i++){
    const toks = tokenize(chunks[i].text);
    tokenized[i] = toks;
    const uniq = new Set(toks);
    uniq.forEach(t => df.set(t, (df.get(t)||0)+1));
    if (onProgress && i%10===0) onProgress(40 + Math.floor((i/N)*30));
  }
  const idf = new Map(); df.forEach((v,k)=> idf.set(k, Math.log((N+1)/(v+1))+1) );
  return { tokenized, idf, chunks };
}
function tfidfVector(toks, idf){
  const tf = new Map();
  toks.forEach(t => tf.set(t, (tf.get(t)||0)+1));
  const vec = new Map();
  tf.forEach((f,t)=> vec.set(t, f * (idf.get(t)||0)) );
  return vec;
}
function dotMap(a,b){ let s=0; if (a.size>b.size){ const tmp=a; a=b; b=tmp; } a.forEach((va,k)=>{ const vb=b.get(k)||0; s+=va*vb; }); return s; }
function normMap(a){ let s=0; a.forEach(v=>s+=v*v); return Math.sqrt(s); }
function cosineMap(a,b){ return dotMap(a,b)/(normMap(a)*normMap(b)+1e-12); }

/* ========== PDF 文字抽取（純前端） ==========
   說明：不使用 pdf.js；這裡提供極簡方案，只對含文字的 PDF 有效。
   若 PDF 以向量或圖片為主，建議改走「預先抽取並貼入 DATASET」的路徑。
   （這段方法對多數由 Word/Google Docs 轉出之 PDF 仍可抽到文字。）
*/
async function naiveExtractTextFromPDF(b64){
  try{
    // 嘗試解析 PDF 的文字物件（非常簡化，非完整 PDF 解碼）
    // 作法：把 base64 → Uint8Array → 以字串掃描常見的文字片段（TJ / Tj）
    const bin = atob(b64);
    const maybeText = [];
    // 將可能的可視字元抽出（避免二進位造成效能問題）
    for (let i=0;i<bin.length;i++){
      const c = bin.charCodeAt(i);
      if (c===10 || c===13 || (c>=32 && c<=126) || (c>=0x80)) {
        maybeText.push(bin[i]);
      } else {
        maybeText.push(' ');
      }
    }
    const s = maybeText.join('');
    // 常見 PDF 字串文字寫法：(...)Tj / [(...)]TJ
    const regex = /\(([^)]{1,2000})\)\s*Tj|\[\s*(?:\([^)]+\)\s*\d+\s*)+\]\s*TJ/g;
    const parts = [];
    let m;
    while ((m = regex.exec(s)) !== null){
      const grp = m[1] || "";
      if (grp) parts.push(grp.replace(/\\([nrtbf()\\/])/g, '$1')); // 反斜線轉義還原
      if (parts.length % 200 === 0) await sleep(1);
    }
    const textJoined = normalize(parts.join(' '));
    if (!textJoined) throw new Error("未能從 PDF 抽到文字；此檔可能是掃描或圖像為主。");
    // 粗略分頁（以常見 'Page ' or '/Type /Page' 出現數估計），此為近似
    const pageCount = Math.max(1, (s.match(/\/Type\s*\/Page/g)||[]).length);
    const perPageLen = Math.ceil(textJoined.length / pageCount);
    const pages = [];
    for (let i=0;i<pageCount;i++){
      pages.push({page: i+1, text: textJoined.slice(i*perPageLen, (i+1)*perPageLen)});
    }
    return { pages, textJoined };
  }catch(e){
    throw e;
  }
}

function chunkPages(pages, chunkChars=900, overlap=150){
  const out = [];
  for (const p of pages){
    const t = normalize(p.text);
    if (!t) continue;
    let i=0, L=t.length;
    while (i<L){
      const end = Math.min(L, i+chunkChars);
      out.push({ id: `${p.page}-${i}`, doc: CURRENT_DOC, page: p.page, text: t.slice(i,end) });
      i = end - overlap; if (i<0) i=0; if (i>=L) break;
    }
  }
  return out;
}

/* ========== 狀態 ========== */
let INDEX = null;
let CURRENT_DOC = "document.pdf";

/* ========== 初始化流程 ========== */
async function initialize({dataset, pdfb64}){
  try{
    setLed(1,"yellow"); setTxt(1,"準備中…"); bar(10);
    if (dataset && Array.isArray(dataset.chunks) && dataset.chunks.length){
      // 走已嵌入資料集（最快）
      CURRENT_DOC = dataset.doc || CURRENT_DOC;
      $meta.textContent = `段落 ${dataset.chunks.length}｜頁數 ${dataset.pages?.length ?? "—"}`;
      setLed(1,"green"); setTxt(1,"載入內嵌資料 OK"); bar(25);
      setLed(2,"yellow"); setTxt(2,"建立 TF-IDF 中…");
      INDEX = tfidfBuild(dataset.chunks, p => bar(p));
      setLed(2,"green"); setTxt(2,"索引 OK"); bar(90);
    } else if (pdfb64) {
      // 走 PDF 抽取
      setTxt(1,"抽取 PDF 文字…"); bar(20);
      const { pages } = await naiveExtractTextFromPDF(pdfb64);
      if (!pages || !pages.length) throw new Error("抽取失敗：沒有文字可用。");
      CURRENT_DOC = "嵌入 PDF";
      setTxt(1, `抽取頁面 ${pages.length} 完成`); bar(35);

      setLed(2,"yellow"); setTxt(2,"分塊＆建索引…");
      const chunks = chunkPages(pages, 900, 150);
      $meta.textContent = `段落 ${chunks.length}｜頁數 ${pages.length}`;
      INDEX = tfidfBuild(chunks, p => bar(p));
      setLed(2,"green"); setTxt(2,"索引 OK"); bar(90);
    } else {
      throw new Error("沒有資料可用：請貼 DATASET 或 PDF base64。");
    }

    setLed(3,"green"); setTxt(3,"就緒"); bar(100);
    $status.textContent = "完成，可以開始提問。";
    $askBtn.disabled = false;
  }catch(e){
    $status.textContent = "初始化失敗：" + e.message;
    log("INIT ERROR: " + (e.stack || e.message));
  }
}

/* ========== 問答 ========== */
document.getElementById("askBtn").onclick = () => {
  const q = $q.value.trim();
  if (!q) return alert("請輸入問題");
  if (!INDEX) return alert("索引尚未建立");

  const toks = tokenize(q);
  const qv = tfidfVector(toks, INDEX.idf);
  const scored = INDEX.chunks.map((c, i) => ({ ...c, score: cosineMap(qv, tfidfVector(INDEX.tokenized[i], INDEX.idf)) }))
                             .sort((a,b)=> b.score - a.score);

  const k = parseInt($topk.value,10)||5;
  const clipLen = parseInt($cliplen.value,10)||360;
  const top = scored.slice(0,k);

  const bullets = top.map(t => "• " + clip(t.text.trim(), clipLen) + ` (p.${t.page}，${t.doc})`);
  $answer.textContent = ["【重點摘錄回答】", bullets.join("\n")].join("\n");

  const cites = []; const seen = new Set();
  for (const t of top){
    const key = t.doc+"#"+t.page;
    if(!seen.has(key)){
      seen.add(key);
      cites.push(`<li><code>${t.doc}</code>．第 <b>${t.page}</b> 頁（相似度 ${t.score.toFixed(3)}）</li>`);
    }
  }
  $cites.innerHTML = cites.length ? `<ol>${cites.join("")}</ol>` : "";
};

/* ========== 事件繫結 ========== */
$initBtn.onclick = async ()=>{
  $status.textContent = "開始初始化…";
  bar(0); setLed(1,"red"); setLed(2,"red"); setLed(3,"red");
  // 優先順序：1) 內嵌物件 EMBEDDED_DATASET；2) textarea dataset；3) 內嵌 PDF_B64；4) textarea pdf
  let ds = EMBEDDED_DATASET;
  if (!ds) {
    try { ds = JSON.parse($datasetBox.value || "null"); } catch { ds = null; }
  }
  let p64 = PDF_B64 || $pdfBox.value.trim();
  // 設定 PDF 下載按鈕
  $downloadPdf.href = p64 ? ("data:application/pdf;base64," + p64) : "data:application/pdf;base64,";
  await initialize({dataset: ds, pdfb64: p64 || null});
};

$extractBtn.onclick = async ()=>{
  // 快速路：只貼 PDF base64，在頁面抽文字、建索引
  const p64 = ($pdfBox.value || PDF_B64 || "").trim();
  if (!p64){ alert("請先貼上 PDF base64"); return; }
  $datasetBox.value = "";
  $status.textContent = "抽取 PDF → 分塊 → 建索引…";
  bar(0); setLed(1,"red"); setLed(2,"red"); setLed(3,"red");
  // 設定 PDF 下載按鈕
  $downloadPdf.href = "data:application/pdf;base64," + p64;
  await initialize({dataset: null, pdfb64: p64});
};

$clearBtn.onclick = ()=>{
  INDEX = null;
  $status.textContent = "已重置。可再次初始化。";
  $answer.textContent = "(尚無回答)";
  $cites.innerHTML = "";
  bar(0); setLed(1,"red"); setLed(2,"red"); setLed(3,"red");
};
</script>
</body>
</html>