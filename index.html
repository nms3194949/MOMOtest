<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç´”å‰ç«¯ RAGï¼ˆå·²é è¼‰ï¼šè¯ç›Ÿè¡ŒéŠ·åŠŸèƒ½èªªæ˜ï¼‰ï½œå«åˆå§‹åŒ–ç‡ˆè™Ÿ</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<style>
  :root{
    --deep:#0A1221; --gold:#C9A227; --ink:#e7ecf3; --muted:#a8b3c7; --card:#0C152A; --line:rgba(233,209,138,.28);
    --ok:#39C27A; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--deep);color:var(--ink);font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .kv{background:#0b1226;border:1px solid var(--line);padding:8px 10px;border-radius:10px}
  .progress{height:12px;border-radius:999px;background:#0b1226;border:1px solid var(--line);overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,#C9A227,#E9D18A);width:0%}
  .subprogress{height:8px;border-radius:999px;background:#0b1226;border:1px solid var(--line);overflow:hidden}
  .subbar{height:100%;background:linear-gradient(90deg,#6EE7B7,#34D399);width:0%}
  .btn{padding:10px 14px;border:1px solid var(--gold);border-radius:12px;background:transparent;color:var(--ink);cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  input,textarea,select{background:#0b1226;border:1px solid var(--line);border-radius:12px;color:var(--ink);padding:10px}
  .answer{white-space:pre-wrap;line-height:1.7}
  .cite{font-size:13px;color:var(--muted)}
  /* LED */
  .led{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;border:1px solid rgba(255,255,255,.2)}
  .red{background:var(--bad)}
  .yellow{background:var(--warn)}
  .green{background:var(--ok)}
  .steps{display:grid;grid-template-columns:24px 1fr auto;gap:8px;align-items:center;margin-top:8px}
  .step{padding:6px 8px;border:1px dashed var(--line);border-radius:10px}
  .right{justify-self:end;color:var(--muted);font-size:12px}
  .hint{font-size:12px;color:#fcd34d;margin-top:6px}
  details summary{cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ“„ ç´”å‰ç«¯æ–‡ä»¶å•ç­”ï¼ˆRAGï¼‰â€” å·²é è¼‰ã€Šè¯ç›Ÿè¡ŒéŠ·åŠŸèƒ½èªªæ˜.pdfã€‹</h1>

  <div class="card">
    <div class="row"><strong>åˆå§‹åŒ–</strong><span id="status" class="muted">å°šæœªé–‹å§‹</span></div>

    <!-- ç¸½é€²åº¦ -->
    <div class="row" style="margin-top:8px">
      <div class="progress" style="flex:1;min-width:240px"><div id="bar" class="bar"></div></div>
      <span id="pct" class="kv">0%</span>
    </div>

    <!-- æ¯æ­¥é©Ÿç‡ˆè™Ÿ -->
    <div class="steps" id="steps">
      <span class="led red" id="led1"></span><div class="step">1) è¼‰å…¥ç¨‹å¼åº«ï¼ˆpdf.js / transformers.js / IndexedDBï¼‰</div><div class="right" id="t1">â€”</div>
      <span class="led red" id="led2"></span><div class="step">2) è§£æå…§å»º PDFï¼ˆbase64 å…§åµŒï¼Œä¸å¤–å‚³ï¼‰</div><div class="right" id="t2">â€”</div>
      <span class="led red" id="led3"></span><div class="step">3) åˆ†å¡Šï¼ˆchunkingï¼‰</div><div class="right" id="t3">â€”</div>
      <span class="led red" id="led4"></span><div class="step">4) è¼‰å…¥æ¨¡å‹ï¼ˆXenova / all-MiniLM-L6-v2, WASMï¼‰</div><div class="right" id="t4">â€”</div>
      <span class="led red" id="led5"></span><div class="step">5) ç”¢ç”Ÿå‘é‡ï¼ˆembeddingï¼‰</div><div class="right" id="t5">â€”</div>
      <span class="led red" id="led6"></span><div class="step">6) å¯«å…¥ç´¢å¼•ï¼ˆIndexedDBï¼‰â†’ å°±ç·’</div><div class="right" id="t6">â€”</div>
    </div>

    <!-- å­é€²åº¦ -->
    <div class="row" style="margin-top:10px">
      <div class="subprogress" style="flex:1;min-width:240px"><div id="subbar" class="subbar"></div></div>
      <span id="subtxt" class="kv">å­é€²åº¦ï¼š0%</span>
    </div>

    <div id="hint" class="hint" style="display:none"></div>

    <div class="row" style="margin-top:10px">
      <button id="retry" class="btn">é‡è©¦åˆå§‹åŒ–</button>
      <button id="clear" class="btn">æ¸…ç©ºç´¢å¼•</button>
    </div>
  </div>

  <div class="card">
    <div class="row"><strong>æå•</strong><span class="muted">ç´¢å¼•å®Œæˆå¾Œå³å¯ä½¿ç”¨</span></div>
    <input id="question" type="text" placeholder="ä¾‹å¦‚ï¼šç¶“éŠ·å•†çš„ç”³è«‹åœ¨å“ªè£¡è¨­å®šï¼Ÿ">
    <div class="row" style="margin-top:8px">
      <label>Top-kï¼š<select id="topk"><option>3</option><option selected>5</option><option>7</option></select></label>
      <label>æ¯æ®µå­—æ•¸ä¸Šé™ï¼š<select id="cliplen"><option>200</option><option selected>360</option><option>500</option></select></label>
      <button id="askBtn" class="btn" disabled>é€å‡ºå•é¡Œ</button>
    </div>
    <div id="answer" class="answer" style="margin-top:10px">ï¼ˆå°šç„¡å›ç­”ï¼‰</div>
    <div id="cites" class="cite"></div>
  </div>

  <details class="card">
    <summary>ğŸ”§ é™¤éŒ¯è³‡è¨Š</summary>
    <pre id="log" style="white-space:pre-wrap;font-size:12px;color:#a1a1aa"></pre>
  </details>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js"></script>
<script>
/* ====== åŸºæœ¬è¨­å®š ====== */
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.worker.min.js";

const DB = localforage.createInstance({ name: "momo-rag-prepack", storeName: "chunks" });
const KEY_META = "meta"; const KEY_DATA = "data"; const PREPACK_KEY = "prepacked_v1";

const $status = document.getElementById("status");
const $bar = document.getElementById("bar");
const $pct = document.getElementById("pct");
const $subbar = document.getElementById("subbar");
const $subtxt = document.getElementById("subtxt");
const $hint = document.getElementById("hint");
const $askBtn = document.getElementById("askBtn");
const $answer = document.getElementById("answer");
const $cites = document.getElementById("cites");
const $q = document.getElementById("question");
const $topk = document.getElementById("topk");
const $cliplen = document.getElementById("cliplen");
const $log = document.getElementById("log");

const leds = [...Array(6)].map((_,i)=>document.getElementById("led"+(i+1)));
const ts = [...Array(6)].map((_,i)=>document.getElementById("t"+(i+1)));

function log(s){ $log.textContent += `${new Date().toLocaleTimeString()}  ${s}\n`; }
function setLed(i,color){ leds[i-1].className = "led " + color; }
function setTxt(i,txt){ ts[i-1].textContent = txt; }
function setStatus(s){ $status.textContent = s; log(s); }
function setHint(s){ $hint.style.display = s? "block":"none"; $hint.textContent = s || ""; }
function bar(p){ $bar.style.width = p+"%"; $pct.textContent = Math.round(p) + "%"; }
function subbar(p,txt){ $subbar.style.width = p+"%"; $subtxt.textContent = "å­é€²åº¦ï¼š" + Math.round(p) + "% " + (txt?("ï½œ"+txt):""); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function clip(t,n){ return (t.length>n)?(t.slice(0,n)+"â€¦"):t; }
function normalize(s){ return s.replace(/\s+/g," ").trim(); }
function toB64F32(arr){ const bytes = new Uint8Array(arr.buffer); let bin=""; for(let b of bytes) bin += String.fromCharCode(b); return btoa(bin); }
function fromB64F32(b){ const bin = atob(b); const bytes = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i); return new Float32Array(bytes.buffer); }
function cosine(a,b){ let dot=0,na=0,nb=0; for(let i=0;i<a.length;i++){ dot+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; } return dot/(Math.sqrt(na)*Math.sqrt(nb)+1e-12); }
function splitSentences(text){ return text.split(/(?<=[ã€‚ï¼ï¼Ÿ.!?])\s+|[\n\r]+/).filter(Boolean); }

let timeouts = []; // æ¯æ­¥ watchdog
function startWatch(i,secs=20, tip){
  clearWatch(i);
  const id = setTimeout(()=>{
    setHint(tip || "åˆå§‹åŒ–ä¼¼ä¹è¼ƒä¹…ï¼Œè‹¥åœ¨ iOS/Safari å¯èƒ½å—è¨˜æ†¶é«”é™åˆ¶ï¼›å»ºè­°æ”¹ç”¨ Wi-Fi/æ¡Œæ©Ÿæˆ–å°‡ PDF åˆ†å‰²å¾Œå†è©¦ã€‚");
    setTxt(i,"é€¾æ™‚â€¦"); setLed(i,"yellow");
  }, secs*1000);
  timeouts[i]=id;
}
function clearWatch(i){ if(timeouts[i]){ clearTimeout(timeouts[i]); timeouts[i]=null; } }

/* ====== è§£æå…§åµŒ PDF ====== */
async function parsePDF(){
  // ç”±æˆ‘æ›¿ä½ å…§åµŒï¼šå¦‚æœä½ è‡ªè¡Œæ›¿æ›ï¼Œè«‹æŠŠ __PDF_B64__ æ›æˆä½ çš„ base64
  const b64 = "__PDF_B64__";
  const data = Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
  const pdf = await pdfjsLib.getDocument({ data }).promise;

  const pages = [];
  for (let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const text = content.items.map(it=>it.str).join(" ");
    pages.push({ doc:"è¯ç›Ÿè¡ŒéŠ·åŠŸèƒ½èªªæ˜.pdf", page:p, text });
    subbar((p/pdf.numPages)*100, `æŠ½å–ç¬¬ ${p}/${pdf.numPages} é `);
    await sleep(4);
  }
  return pages;
}

/* ====== åµŒå…¥å™¨ ====== */
let embedPipe = null;
async function getEmbedder(){
  if (embedPipe) return embedPipe;
  embedPipe = await window.transformers.pipeline("feature-extraction","Xenova/all-MiniLM-L6-v2");
  return embedPipe;
}

/* ====== å»ºç«‹ç´¢å¼• ====== */
async function buildIndex(){
  // 1) è¼‰å…¥ç¨‹å¼åº«
  setStatus("æ­¥é©Ÿ 1/6ï¼šè¼‰å…¥ç¨‹å¼åº«â€¦");
  setLed(1,"yellow"); startWatch(1,15,"è‹¥å¡ä½ï¼šæª¢æŸ¥ç¶²è·¯ï¼CDN æ˜¯å¦è¢«æ“‹ï¼Œæˆ–æ”¹ç”¨ 4G/æ¡Œæ©Ÿã€‚");
  await sleep(200); // è®“ UI æœ‰æ„Ÿ
  clearWatch(1); setLed(1,"green"); setTxt(1,"OK"); bar(8);

  // å¦‚æœå·²å­˜åœ¨ç´¢å¼•ï¼Œç›´æ¥å°±ç·’
  const cached = await DB.getItem(KEY_DATA);
  if (cached && cached.length){
    setStatus(`åµæ¸¬åˆ°ç¾æœ‰ç´¢å¼•ï¼ˆ${cached.length} æ®µï¼‰ï¼Œç›´æ¥å°±ç·’ã€‚`);
    setLed(2,"green"); setLed(3,"green"); setLed(4,"green"); setLed(5,"green"); setLed(6,"green");
    setTxt(2,"ç•¥é"); setTxt(3,"ç•¥é"); setTxt(4,"ç•¥é"); setTxt(5,"ç•¥é"); setTxt(6,"OK");
    bar(100); subbar(100,"å·²å°±ç·’"); $askBtn.disabled=false; return;
  }

  // 2) è§£æ PDF
  setStatus("æ­¥é©Ÿ 2/6ï¼šè§£æå…§å»º PDFâ€¦");
  setLed(2,"yellow"); startWatch(2,20,"PDF è§£æè¼ƒä¹…ï¼šè¡Œå‹•è£ç½®å¯ç¨æ…¢ï¼Œè«‹è€å¿ƒç­‰å€™æˆ–æ›æ¡Œæ©Ÿã€‚");
  const pages = await parsePDF(); clearWatch(2); setLed(2,"green"); setTxt(2,`å…± ${pages.length} é `);
  bar(20);

  // 3) åˆ†å¡Š
  setStatus("æ­¥é©Ÿ 3/6ï¼šåˆ†å¡Šï¼ˆchunkingï¼‰â€¦");
  setLed(3,"yellow"); startWatch(3,10);
  const chunks = [];
  const chunkChars = 900, overlap = 150;
  for (let i=0;i<pages.length;i++){
    const t = normalize(pages[i].text);
    let j=0; const L = t.length;
    while(j < L){
      const end = Math.min(L, j+chunkChars);
      chunks.push({ id: crypto.randomUUID(), doc: pages[i].doc, page: pages[i].page, text: t.slice(j,end) });
      j = end - overlap; if (j<0) j=0; if (j>=L) break;
    }
    subbar(((i+1)/pages.length)*100, `è™•ç†ç¬¬ ${i+1}/${pages.length} é `);
    await sleep(2);
  }
  clearWatch(3); setLed(3,"green"); setTxt(3,`æ®µè½ ${chunks.length}`); bar(35);

  // 4) è¼‰å…¥æ¨¡å‹
  setStatus("æ­¥é©Ÿ 4/6ï¼šè¼‰å…¥æ¨¡å‹ï¼ˆWASMï¼‰â€¦");
  setLed(4,"yellow"); startWatch(4,30,"æ¨¡å‹è¼‰å…¥å—ç¶²é€Ÿå½±éŸ¿ï¼ˆæ•¸å MBï¼‰ï¼›è‹¥å¡ä½ï¼Œè«‹åˆ‡æ›ç¶²è·¯æˆ–ç¨å€™ã€‚");
  const pipe = await getEmbedder(); clearWatch(4); setLed(4,"green"); setTxt(4,"OK"); bar(50);

  // 5) ç”¢ç”Ÿå‘é‡
  setStatus("æ­¥é©Ÿ 5/6ï¼šç”¢ç”Ÿå‘é‡ï¼ˆembeddingï¼‰â€¦");
  setLed(5,"yellow"); startWatch(5,30,"å‘é‡è¨ˆç®—è¼ƒè€—æ™‚ï¼›è£ç½®è¼ƒèˆŠæœƒæ…¢ï¼Œè«‹ä¿æŒç•«é¢å–šé†’ã€‚");
  const stored = [];
  for (let i=0;i<chunks.length;i++){
    const emb = await pipe(chunks[i].text, { pooling:"mean", normalize:true });
    stored.push({ ...chunks[i], vector: toB64F32(emb.data) });
    const p = ((i+1)/chunks.length)*100;
    subbar(p, `åµŒå…¥ ${i+1}/${chunks.length}`);
    if ((i+1)%3===0) await sleep(1);
  }
  clearWatch(5); setLed(5,"green"); setTxt(5,`å®Œæˆ ${stored.length}`); bar(85);

  // 6) å¯«å…¥ç´¢å¼•
  setStatus("æ­¥é©Ÿ 6/6ï¼šå¯«å…¥ç´¢å¼•â€¦");
  setLed(6,"yellow"); startWatch(6,10);
  await DB.setItem(KEY_DATA, stored);
  await DB.setItem(KEY_META, { model:"Xenova/all-MiniLM-L6-v2", createdAt:Date.now(), totalChunks:stored.length });
  await DB.setItem(PREPACK_KEY, true);
  clearWatch(6); setLed(6,"green"); setTxt(6,"OK"); bar(100); subbar(100,"å®Œæˆ");
  setStatus("åˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥é–‹å§‹æå•ã€‚");
  $askBtn.disabled = false;
}

/* ====== æå• ====== */
$askBtn.onclick = async () => {
  const q = $q.value.trim();
  if (!q) return alert("è«‹è¼¸å…¥å•é¡Œ");
  const data = await DB.getItem(KEY_DATA);
  if (!data || !data.length) return alert("ç´¢å¼•å°šæœªå»ºç«‹");

  setStatus("æª¢ç´¢ä¸­â€¦");
  const pipe = await getEmbedder();
  const qv = (await pipe(q, { pooling:"mean", normalize:true })).data;

  const scored = data.map(r => ({ ...r, score: cosine(qv, fromB64F32(r.vector)) }))
                     .sort((a,b)=> b.score - a.score);

  const k = parseInt($topk.value,10)||5;
  const clipLen = parseInt($cliplen.value,10)||360;
  const top = scored.slice(0,k);

  const bullets = top.map(t => "â€¢ " + clip(t.text.trim(), clipLen) + ` (p.${t.page}ï¼Œ${t.doc})`);
  $answer.textContent = ["ã€é‡é»æ‘˜éŒ„å›ç­”ã€‘", bullets.join("\n")].join("\n");

  const cites = []; const seen = new Set();
  for (const t of top){
    const key = t.doc+"#"+t.page;
    if(!seen.has(key)){
      seen.add(key);
      cites.push(`<li><code>${t.doc}</code>ï¼ç¬¬ <b>${t.page}</b> é ï¼ˆç›¸ä¼¼åº¦ ${t.score.toFixed(3)}ï¼‰</li>`);
    }
  }
  $cites.innerHTML = cites.length ? `<ol>${cites.join("")}</ol>` : "";
  setStatus("å®Œæˆ");
};

/* ====== æ§ä»¶ï¼šé‡è©¦ & æ¸…ç©º ====== */
document.getElementById("retry").onclick = async ()=>{
  setHint(""); bar(0); subbar(0,"");
  leds.forEach((_,i)=>setLed(i+1,"red")); ts.forEach(el=>el.textContent="â€”");
  await buildIndex();
};
document.getElementById("clear").onclick = async ()=>{
  await DB.removeItem(KEY_DATA);
  await DB.removeItem(KEY_META);
  await DB.removeItem(PREPACK_KEY);
  setStatus("å·²æ¸…ç©ºç´¢å¼•ã€‚å¯æŒ‰ã€Œé‡è©¦åˆå§‹åŒ–ã€é‡æ–°å»ºç«‹ã€‚");
  $askBtn.disabled = true; bar(0); subbar(0,""); leds.forEach((_,i)=>setLed(i+1,"red")); ts.forEach(el=>el.textContent="â€”");
};

/* ====== å•Ÿå‹• ====== */
(async function init(){
  setStatus("é–‹å§‹åˆå§‹åŒ–â€¦");
  await buildIndex();
})();
</script>
</body>
</html>