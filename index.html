<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MOMOï½œå°è‚¡æ”¶ç›¤ Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --deep:#0A1221; --card:#0C152A;
      --gold:#E5C45A; --muted:#9AA4B2;
      --up:#4CAF50; --down:#F44336;
    }
    body{background:var(--deep);color:#EDEFF5;font-family:"Noto Sans TC",sans-serif;margin:0;padding:20px;}
    h1{color:var(--gold);margin-bottom:6px;}
    .container{max-width:900px;margin:auto;}
    .card{background:var(--card);padding:16px;border-radius:12px;margin-top:16px;border:1px solid rgba(233,209,138,0.2);}
    .row{display:flex;gap:8px;flex-wrap:wrap;}
    input,button,select{
      background:#121C33;color:#EDEFF5;border:1px solid #2E3A55;border-radius:8px;padding:8px;
    }
    button{background:var(--gold);color:var(--deep);font-weight:700;cursor:pointer;}
    table{width:100%;border-collapse:collapse;margin-top:12px;}
    th,td{padding:6px 8px;border-bottom:1px solid #2E3A55;text-align:right;}
    th{text-align:center;color:var(--gold);}
    td.name{text-align:left;}
    .up{color:var(--up);} .down{color:var(--down);}
    canvas{margin-top:16px;}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ’ MOMOï½œæ¯æ—¥å°è‚¡æ”¶ç›¤ Dashboard</h1>
    <div class="card">
      <div class="row">
        <label>è‚¡ç¥¨ä»£è™Ÿï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
        <input id="codes" value="2330,2317,2615,2377,3481" style="flex:1"/>
        <button onclick="loadData()">æŸ¥è©¢</button>
      </div>
      <div id="dateInfo" style="margin-top:8px;color:var(--muted)">è³‡æ–™è¼‰å…¥ä¸­...</div>
      <table id="stockTable"></table>
      <canvas id="barChart" height="200"></canvas>
      <canvas id="lineChart" height="220"></canvas>
    </div>
  </div>

<script>
const api = "https://api.finmindtrade.com/api/v4/data";
const token = ""; // â† å¯å¡«å…¥ä½ çš„ FinMind tokenï¼ˆéå¿…é ˆï¼Œä½†æœƒå¢åŠ é…é¡ï¼‰

async function fetchStock(code){
  const end = new Date().toISOString().slice(0,10);
  const start = new Date(Date.now()-30*86400000).toISOString().slice(0,10);
  const url = `${api}?dataset=TaiwanStockPrice&data_id=${code}&start_date=${start}&end_date=${end}${token ? "&token="+token : ""}`;
  const r = await fetch(url);
  const j = await r.json();
  if(!j.data || j.data.length===0) return null;
  return j.data;
}

async function loadData(){
  const codes = document.getElementById("codes").value.trim().split(",").map(c=>c.trim());
  const rows = [];
  const chartLabels = [], chartSets = [];
  let lastDate = "";

  for(const code of codes){
    const data = await fetchStock(code);
    if(!data) continue;
    const last = data[data.length-1];
    const prev = data[data.length-2];
    const close = last.close;
    const change = ((close - prev.close) / prev.close * 100).toFixed(2);
    lastDate = last.date;
    rows.push({code,close,change});
    chartLabels.push(code);
    chartSets.push(Number(change));
  }

  renderTable(rows, lastDate);
  renderBar(chartLabels, chartSets, lastDate);

  // æŠ˜ç·šåœ–ï¼šé¡¯ç¤ºç¬¬ä¸€æª”ï¼ˆé è¨­2330ï¼‰
  if(codes[0] && rows.length>0){
    const firstData = await fetchStock(codes[0]);
    renderLine(firstData, codes[0]);
  }
}

function renderTable(rows, date){
  const el = document.getElementById("stockTable");
  document.getElementById("dateInfo").textContent = `TW close ${date}`;
  let html = "<tr><th>ä»£è™Ÿ</th><th>æ”¶ç›¤</th><th>æ¼²è·Œå¹…</th></tr>";
  for(const r of rows){
    const cls = r.change>0?"up":(r.change<0?"down":"");
    html += `<tr><td class="name">${r.code}</td><td>${r.close}</td><td class="${cls}">${r.change>0?"+":""}${r.change}%</td></tr>`;
  }
  el.innerHTML = html;
}

function renderBar(labels, data, date){
  const ctx = document.getElementById("barChart").getContext("2d");
  if(window.barChart) window.barChart.destroy();
  window.barChart = new Chart(ctx, {
    type:"bar",
    data:{
      labels,
      datasets:[{
        label:`æ—¥æ¼²è·Œå¹… (%)`,
        data,
        backgroundColor:data.map(v=>v>0?"#4CAF50":v<0?"#F44336":"#9E9E9E")
      }]
    },
    options:{
      plugins:{title:{display:true,text:`å°è‚¡æ”¶ç›¤ (${date})`,color:"#E5C45A"}},
      scales:{y:{ticks:{color:"#EDEFF5"},grid:{color:"rgba(255,255,255,.1)"}},
              x:{ticks:{color:"#EDEFF5"}}}
    }
  });
}

function renderLine(data, code){
  const ctx = document.getElementById("lineChart").getContext("2d");
  if(window.lineChart) window.lineChart.destroy();
  const labels = data.map(d=>d.date.slice(5));
  const closes = data.map(d=>d.close);
  window.lineChart = new Chart(ctx,{
    type:"line",
    data:{labels,datasets:[{label:`${code} æ”¶ç›¤åƒ¹`,data:closes,borderColor:"#E5C45A",fill:false,tension:.2}]},
    options:{plugins:{title:{display:true,text:`${code} è¿‘30æ—¥æ”¶ç›¤åƒ¹`,color:"#E5C45A"}},
              scales:{y:{ticks:{color:"#EDEFF5"},grid:{color:"rgba(255,255,255,.1)"}},
                      x:{ticks:{color:"#EDEFF5"}}}}
  });
}

loadData();
</script>
</body>
</html>