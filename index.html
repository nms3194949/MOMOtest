<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>BTC/ETH å›æ’¤é€²å‡ºå ´ç­–ç•¥å›æ¸¬ & å³æ™‚æ—¥ç·šï¼ˆBinanceï¼‰ï½œå¤–æ¡† 3px Ã— å…§æ¡† 1px æ·¡é‡‘</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    :root{
      --deep:#0A1221;
      --deep-2:#0C152A;
      --text:#EDEFF5;
      --muted:#9AA4B2;

      --gold:#D8B84E;
      --gold-soft:#EEDFA6;
      --gold-soft-25: rgba(238,223,166,.25);
      --gold-soft-35: rgba(238,223,166,.35);

      --ok:#22C55E; --warn:#F59E0B; --bad:#EF4444;
      --violet:#A855F7;
    }

    html{overflow-y:scroll;height:100%;}
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",Arial,sans-serif;
      color:var(--text);
      background: var(--deep);
    }

    /* æœ€å¤–å±¤ç²—ç·š 3px */
    header{
      padding:28px 20px 12px;
      border-bottom:3px solid var(--gold-soft);
      background: var(--deep);
    }
    h1{margin:0 0 6px;font-size:22px;letter-spacing:.3px}
    .sub{color:var(--gold);font-size:13px}

    main{padding:18px;max-width:1280px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:981px){
      .card:first-of-type, .card:last-of-type{max-width:1000px;margin:0 auto;}
    }

    /* å¡ç‰‡å…§æ¡† 1px */
    .card{
      background: var(--deep-2);
      border: 1px solid var(--gold-soft-35) !important;
      border-radius:14px;
      padding:16px;
      box-shadow:none;
    }
    .card-outer{ border: 3px solid var(--gold-soft) !important; }

    .section-title{font-size:14px;color:var(--muted);margin:0 0 10px;letter-spacing:.2px}

    .controls .row{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap:10px;margin-bottom:10px;align-items:center;
    }
    .controls label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .controls input[type=file],.controls input[type=number],.controls select{
      width:100%;background:var(--deep);color:var(--text);
      border:1px solid var(--gold-soft-35) !important;
      border-radius:10px;padding:10px 12px;outline:none
    }
    .btn{
      display:inline-block;
      padding:10px 14px;
      border:1px solid var(--gold-soft-35);
      color:var(--text);
      border-radius:10px;
      background:transparent;
      text-decoration:none;
      text-align:center;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(216,184,78,.08);filter:brightness(1.05)}
    .pill{
      display:inline-block;padding:2px 8px;font-size:12px;border-radius:999px;
      border:1px solid var(--gold-soft-35) !important;color:var(--gold);background:transparent
    }
    .hr{height:1px;background:var(--gold-soft-35);margin:10px 0}

    .collapsible-header{cursor:pointer;display:flex;justify-content:space-between;align-items:center;margin:10px 0;padding:0 0 5px 0;border-bottom:1px dashed var(--gold-soft-35);}
    .collapsible-content{overflow:hidden;transition:max-height 0.3s ease-out}
    .arrow{display:inline-block;transition:transform .3s;font-size:16px;color:var(--gold);margin-right:5px}
    .collapsed .arrow{transform:rotate(-90deg)}

    .param-flex-container{display:flex;flex-wrap:nowrap;overflow-x:auto;gap:20px;margin-top:15px;padding-bottom:5px}
    .param-group{flex:1 0 250px;max-width:350px;border:1px solid var(--gold-soft-35) !important;border-radius:10px;padding:12px;background:var(--deep);}

    table{width:100%;border-collapse:collapse;border-spacing:0;border:1px solid var(--gold-soft-35) !important;background:var(--deep);border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;font-size:13px;border-right:1px solid var(--gold-soft-25);border-bottom:1px solid var(--gold-soft-25)}
    th:last-child, td:last-child{border-right:none}
    tr:last-child td{border-bottom:none}
    #summaryTable1, #summaryTable2, #entriesTable {border:1px solid var(--gold-soft-35) !important; background:var(--deep);}
    #summaryTable1 th,#summaryTable1 td,#summaryTable2 th,#summaryTable2 td{white-space:nowrap;padding:8px 10px}
    #summaryTable1 thead th,#summaryTable2 thead th{border-bottom:1px solid var(--gold-soft-35)}
    #summaryTable1 td,#summaryTable2 td{text-align:center;font-weight:600;color:var(--text)}
    th{text-align:left;color:var(--gold); background: var(--deep-2); position:sticky;top:0}
    tbody tr:hover{background:#101a2f; outline:1px solid var(--gold-soft-35)}

    .data-ok{color:var(--ok)} .data-bad{color:var(--bad)} .data-warn{color:var(--warn)}
    .traffic-light{height:12px;width:12px;background-color:var(--ok);border-radius:50%;display:inline-block;margin-right:5px;vertical-align:middle;border:1px solid var(--gold-soft-35)}
    .traffic-light.bad{background-color:var(--bad)}

    #aiSuggestionCard{padding:12px;border:1px solid var(--gold-soft-35) !important;border-radius:10px;background:var(--deep);}
    #aiSuggestionCard h4{margin:0 0 8px;font-size:14px;color:var(--gold);display:flex;align-items:center}
    #aiSuggestionCard .advice-type{font-weight:bold;margin-right:8px;color:var(--ok)}
    #aiSuggestionCard .advice-type.bad{color:var(--bad)}
    #aiSuggestionCard .advice-type.warn{color:var(--warn)}
    #aiSuggestionCard ul{list-style:disc;padding-left:20px;margin:6px 0 0;font-size:13px;color:var(--muted)}

    button{background:transparent;border:1px solid var(--gold-soft-35) !important;border-radius:10px;padding:8px 12px;color:var(--text);cursor:pointer;}
    button:hover{background:rgba(216,184,78,.08);filter:brightness(1.05)}
    button:disabled{opacity:.5;cursor:not-allowed}

    .scrollbox{max-height:300px;overflow:auto;scrollbar-gutter:stable;border:1px solid var(--gold-soft-35) !important;border-radius:10px;background:var(--deep)}

    .backtest-results{display:flex;flex-direction:column;gap:16px;padding-top:0}
    .backtest-results .section-title{margin-top:10px;margin-bottom:0}

    .chart-wrap{height:480px;border:1px solid var(--gold-soft-35) !important;border-radius:12px;background:var(--deep)}
    canvas{width:100%;height:100%;background-color:var(--deep);border-radius:10px}

    .metric{border:1px solid var(--gold-soft-35) !important;border-radius:8px;padding:8px;background:var(--deep);text-align:center;}
    .metric .k{font-size:12px;color:var(--muted)}
    .metric .v{font-size:16px;font-weight:bold;color:var(--gold)}

    /* å³æ™‚æ—¥ç·šï¼šæç¤ºéŸ³èˆ‡ç‡ˆè™Ÿ */
    .live-tools{display:flex;align-items:center;gap:16px;margin:6px 0 10px;flex-wrap:wrap}
    .lamp{width:12px;height:12px;border-radius:50%;border:1px solid var(--gold-soft-35);display:inline-block;vertical-align:middle;margin-right:6px;background:transparent}
    .lamp.on.entry{background:var(--gold);}
    .lamp.on.exit{background:var(--violet);}
    .live-badges{display:flex;align-items:center;gap:18px;color:var(--muted);font-size:13px}
    .live-badges label{display:flex;align-items:center;gap:8px;user-select:none;cursor:pointer}
    .toggle{display:flex;align-items:center;gap:6px}
  </style>
</head>
<body>
<header>
  <h1>BTC / ETH å›æ’¤é€²å‡ºå ´ç­–ç•¥å›æ¸¬ï¼ˆä¸Šå‚³ï¼‰ + å³æ™‚æ—¥ç·šï¼ˆBinanceï¼‰</h1>
  <div class="sub">ç´”è‰²ç‰ˆï¼šå·¦å´ <b>å›æ¸¬æ§åˆ¶</b>ï¼Œå³å´ <b>å³æ™‚æ—¥ç·šï¼‹æ‘˜è¦å¡ï¼‹æŠ˜ç·šåœ–</b>ï¼ˆæœ€å¤–å±¤ç·š 3pxï¼Œå…¶é¤˜ 1px æ·¡é‡‘ï¼‰ã€‚</div>
</header>

<main class="grid">
  <section class="card controls card-outer">
    <h3 class="section-title">è³‡æ–™èˆ‡åƒæ•¸ï¼ˆå›æ¸¬ï¼‰</h3>

    <div class="row">
      <div>
        <label>é¸æ“‡ Excelï¼ˆå«ã€Œæ—¥æœŸã€ã€Œæ”¶å¸‚ã€ï¼‰æˆ– CSV</label>
        <input accept=".xlsx,.xls,.csv" id="file" type="file" />
      </div>
      <div>
        <label>ç‹€æ…‹</label>
        <div class="pill" id="status">ç­‰å¾…é¸æª”</div>
      </div>
      <div>
        <label style="visibility:hidden">_</label>
        <a class="btn" href="https://hk.investing.com/crypto/bitcoin/historical-data" target="_blank" rel="noopener">BTCæ­·å²æ•¸æ“š</a>
      </div>
    </div>

    <div class="row">
      <div>
        <label>æœŸé–“ï¼ˆè¿‘ï¼‰</label>
        <select id="years">
          <option value="1">1 å¹´</option>
          <option value="2" selected>2 å¹´</option>
          <option value="3">3 å¹´</option>
        </select>
      </div>
    </div>

    <div class="param-flex-container">
      <div class="param-group">
        <h4 class="section-title">é€²å ´è¨­å®š</h4>
        <div class="row">
          <div>
            <label>æ»¾å‹•é«˜é»è¦–çª—ï¼ˆé€²å ´ï¼‰</label>
            <select id="entryLookback">
              <option value="30">30 å¤©</option>
              <option value="60">60 å¤©</option>
              <option value="90" selected>90 å¤©</option>
              <option value="180">180 å¤©</option>
            </select>
          </div>
          <div>
            <label>å›æª”è§¸ç™¼ï¼ˆ%ï¼‰</label>
            <input id="entryPullback" type="number" min="5" max="30" step="1" value="20" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>æ¯å­£æœ€å¤šé€²å ´æ¬¡æ•¸</label>
            <select id="maxPerQ">
              <option value="1">1 æ¬¡</option>
              <option value="2" selected>2 æ¬¡</option>
              <option value="3">3 æ¬¡</option>
              <option value="4">4 æ¬¡</option>
              <option value="5">5 æ¬¡</option>
            </select>
          </div>
          <div style="display:none;"></div>
        </div>
      </div>

      <div class="param-group">
        <h4 class="section-title">å‡ºå ´è¨­å®š</h4>
        <div class="row">
          <div>
            <label>åŸºæº–é«˜é»è¦–çª—ï¼ˆå‡ºå ´ï¼å‰é«˜åŸºæº–ï¼‰</label>
            <select id="exitLookback">
              <option value="30" selected>30 å¤©</option>
              <option value="60">60 å¤©</option>
              <option value="90">90 å¤©</option>
              <option value="180">180 å¤©</option>
            </select>
          </div>
          <div>
            <label>è¿‘é«˜å›è½è§¸ç™¼ï¼ˆ%ï¼‰</label>
            <input id="exitDrawdown" type="number" min="5" max="30" step="1" value="15" />
          </div>
        </div>
        
        <div class="row">
          <div>
            <label>æ¬¡é«˜å›è½è§¸ç™¼ï¼ˆ%ï¼‰</label>
            <input id="exitSecondPeakDrawdown" type="number" min="1" max="30" step="1" value="5" />
          </div>
          <div>
            <label>å‡ºå ´æ¯”ä¾‹ï¼ˆ% å€‰ä½ï¼‰</label>
            <input id="exitSellPct" type="number" min="10" max="100" step="5" value="15" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>æ¯å­£æœ€å¤šå‡ºå ´æ¬¡æ•¸</label>
            <select id="maxExitPerQ">
              <option value="1">1 æ¬¡</option>
              <option value="2" selected>2 æ¬¡</option>
              <option value="3">3 æ¬¡</option>
              <option value="4">4 æ¬¡</option>
              <option value="5">5 æ¬¡</option>
            </select>
          </div>
          <div style="display:none;"></div>
        </div>
        <div class="row" style="grid-template-columns:1fr;">
          <div><label><input id="exitNonNegRoi" type="checkbox" checked style="vertical-align:middle;margin-right:6px;" />ROI < 0 ä¸å‡ºå ´ï¼ˆä»¥ä¿è­‰é‡‘è¨ˆï¼‰</label></div>
        </div>
        <div class="row" style="grid-template-columns:1fr;">
          <div><label><input id="exitAboveAvgOnly" type="checkbox" checked style="vertical-align:middle;margin-right:6px;" />å‡ºå ´åƒ¹ä½æ–¼å€‰ä½å‡åƒ¹ä¸å‡ºå ´</label></div>
        </div>
      </div>

      <div class="param-group">
        <div class="collapsible-header" data-target="controlRisk">
          <h4 class="section-title" style="margin:0;">é¢¨æ§</h4><span class="arrow">â–¼</span>
        </div>
        <div id="controlRisk" class="collapsible-content">
          <div class="row">
            <div>
              <label>å®‰å…¨é‚Šéš›ï¼ˆ%ï¼‰</label>
              <input id="safetyFloor" type="number" min="1" max="50" step="1" value="10" />
            </div>
            <div>
              <label>æ˜¯å¦å•Ÿç”¨å®‰å…¨é‚Šéš›</label>
              <select id="safetyMode">
                <option value="on" selected>å•Ÿç”¨ï¼ˆæ¬¡æ—¥æ”¶ç›¤å…¨å‡ºï¼‰</option>
                <option value="off">ä¸ä½¿ç”¨</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="param-group">
        <div class="collapsible-header" data-target="controlFund">
          <h4 class="section-title" style="margin:0;">è³‡é‡‘åƒæ•¸</h4><span class="arrow">â–¼</span>
        </div>
        <div id="controlFund" class="collapsible-content">
          <div class="row">
            <div>
              <label>å›ºå®šä¿è­‰é‡‘ (USD)</label>
              <input id="margin" type="number" min="100" step="100" value="3000" />
            </div>
            <div>
              <label>å–®æ¬¡é€²å ´åç›® (USD)</label>
              <input id="lot" type="number" min="100" step="100" value="6000" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>æ§“æ¡¿ä¸Šé™ (Ã—)</label>
              <input id="lev" type="number" min="1" max="100" step="1" value="20" />
            </div>
            <div>
              <label style="color:var(--gold)">æ»¿å€‰ä¸Šé™ï¼ˆè‡ªå‹•ï¼‰</label>
              <input id="maxNotional" type="number" value="60000" disabled />
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="footnote">å›æ¸¬ä»¥<b>æ—¥æ”¶ç›¤</b>åˆ¤å®šï¼ˆä¸çœ‹å½±ç·šï¼‰ã€‚å ±é…¬ä»¥<b>ä¿è­‰é‡‘ç‚ºåŸºæº–</b>ï¼›è‹¥ä»»ä¸€æ—¥æ·¨å€¼ â‰¤ 0 è¦–ç‚ºçˆ†å€‰ï¼ˆROI = -100%ï¼‰ã€‚</div>
  </section>

  <section class="card card-outer" id="resultCard">
    <section class="card" style="margin-bottom:14px;">
      <h3 class="section-title">
        å³æ™‚æ—¥ç·šï¼ˆBinance
        <select id="symbol" style="background:var(--deep);color:var(--text);border:1px solid var(--gold-soft-35);border-radius:8px;padding:4px 8px;margin-left:6px;">
          <option value="BTCUSDT" selected>BTC/USDT</option>
          <option value="ETHUSDT">ETH/USDT</option>
        </select>
        ï¼Œå€é–“
        <select id="range" style="background:var(--deep);color:var(--text);border:1px solid var(--gold-soft-35);border-radius:8px;padding:4px 8px;margin-left:6px;">
          <option value="1M">è¿‘ 1 å€‹æœˆ</option>
          <option value="3M" selected>è¿‘ 3 å€‹æœˆ</option>
          <option value="6M">è¿‘ 6 å€‹æœˆ</option>
          <option value="1Y">è¿‘ 1 å¹´</option>
          <option value="3Y">è¿‘ 3 å¹´</option>
          <option value="ALL">å…¨éƒ¨</option>
        </select>
        ï¼‰
      </h3>

      <div class="live-tools">
        <div class="toggle">
          <input id="toggleSoundEntry" type="checkbox" checked>
          <label for="toggleSoundEntry">é€²å ´æç¤ºéŸ³</label>
        </div>
        <div class="toggle">
          <input id="toggleSoundExit" type="checkbox" checked>
          <label for="toggleSoundExit">å‡ºå ´æç¤ºéŸ³</label>
        </div>
        <div style="font-size:12px;color:var(--muted)">ï¼ˆåƒ¹æ ¼è§¸ç™¼æ™‚æ¯ç§’ 1 éŸ¿ï¼‰</div>

        <div class="live-badges" style="margin-left:auto;">
          <label><span id="lamp_entry" class="lamp"></span>é€²å ´è§¸ç™¼</label>
          <label><span id="lamp_exit" class="lamp"></span>å‡ºå ´è§¸ç™¼</label>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:8px;">
        <div class="metric"><div class="k">ç¾åƒ¹</div><div class="v" id="live_price">â€”</div></div>
        <div class="metric"><div class="k">è¿‘ N æ—¥é«˜é»ï¼ˆé€²å ´ï¼‰</div><div class="v" id="live_rh">â€”</div></div>
        <div class="metric"><div class="k">è§¸ç™¼åƒ¹ï¼ˆé€²å ´ï¼‰</div><div class="v" id="live_trigger">â€”</div></div>
        <div class="metric"><div class="k">è¿‘ M æ—¥æ»¾å‹•é«˜é»ï¼ˆå‡ºå ´ï¼‰</div><div class="v" id="live_rh_exit">â€”</div></div>
        <div class="metric"><div class="k">è§¸ç™¼åƒ¹ï¼ˆå‡ºå ´ï¼‰</div><div class="v" id="live_trigger_exit">â€”</div></div>
      </div>

      <div class="chart-wrap"><canvas id="liveChart"></canvas></div>
      <div class="footnote" id="live_note">èªªæ˜ï¼šä»¥ Binance 1D K ç·šè¨ˆç®—æ»¾å‹•é«˜é»ï¼ˆ<b>ä¸å«ç•¶æ—¥</b>ï¼‰ã€‚ç¾åƒ¹ä»¥ WebSocket ç§’ç´šæ›´æ–°ã€‚</div>
    </section>

    <div class="backtest-results">
      <h3 class="section-title">å›æ¸¬çµæœï¼ˆä¸Šå‚³æª”ï¼‰</h3>

      <div style="display:flex;flex-direction:column;gap:10px;padding:0 6px;">
        <table id="summaryTable1"><thead></thead><tbody></tbody></table>
        <table id="summaryTable2"><thead></thead><tbody></tbody></table>
      </div>

      <div id="aiSuggestionCard" style="padding:12px 16px;margin:0 6px;">
        <h4>AI åƒæ•¸èª¿æ•´å»ºè­°</h4>
        <div id="aiAdviceContent">è«‹å…ˆä¸Šå‚³æª”æ¡ˆä¸¦åŸ·è¡Œå›æ¸¬ä»¥ç²å¾—å»ºè­°ã€‚</div>
      </div>

      <div class="chart-wrap"><canvas id="chart"></canvas></div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:0 6px 10px;">
        <button id="exportEntries" disabled>ä¸‹è¼‰é€²å‡ºå ´ç´€éŒ„ CSV</button>
        <button id="exportSummary" disabled>ä¸‹è¼‰æ‘˜è¦ CSV</button>
        <button id="exportChartPng" disabled>ä¸‹è¼‰çµæœ PNG (åœ–è¡¨+ç´€éŒ„)</button>
      </div>

      <div>
        <div class="section-title" style="margin-bottom:6px;">é€²å‡ºå ´ç´€éŒ„</div>
        <div class="scrollbox" id="entriesScrollbox">
          <table id="entriesTable"><thead><tr></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  /* ========= Chart.js å…¨åŸŸ ========= */
  if (window.Chart && Chart.defaults) {
    Chart.defaults.animation = false;
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
  }

  let _resizeHold = false, _resizeT = null;
  window.addEventListener('resize', () => {
    _resizeHold = true;
    clearTimeout(_resizeT);
    _resizeT = setTimeout(() => { _resizeHold = false; }, 250);
  });

  const $ = s => document.querySelector(s);
  const iso = d => new Date(d).toISOString().slice(0,10);
  const fmt = (n,d=2)=> (n==null||isNaN(n))?'â€”':Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
  function uiLog(msg){ const el=$('#status'); if(el) el.textContent=msg; }

  /* ========= å³æ™‚æ—¥ç·š ========= */
  let liveChart, ws=null, lastLivePrice=null, liveData=[], liveDataFull=[];
  let currentSymbol='BTCUSDT', lastWSUpdate=0;
  let liveRH_entry=null, liveTrigger_entry=null;
  // âœ¨ NEW: liveTrigger_exit ç¾åœ¨æ˜¯ RH-based çš„è§¸ç™¼åƒ¹
  let liveRH_exit=null, liveTrigger_exit=null; 

  const cPrice = '#EDEFF5';
  const cAvg   = '#EEDFA6';
  const cLiq   = '#EF4444';
  const cEntry = '#22C55E';
  const cExit  = '#F59E0B';
  const cRH    = '#EEDFA6';
  const cTrigger = '#D8B84E';
  const cTriggerExit = '#A855F7';
  const cLow  = '#ff6bb5'; 

  async function fetchBinanceKlines(symbol, limitDays){
    const url = `https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(symbol)}&interval=1d&limit=${limitDays}`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('Binance Kç·šæŠ“å–å¤±æ•—ï¼šHTTP '+r.status);
    const arr = await r.json();
    return arr.map(k=>({ time:new Date(k[0]), close:Number(k[4]) }));
  }
  function getRangeDays(code){ switch(code){case '1M':return 31;case '3M':return 93;case '6M':return 186;case '1Y':return 366;case '3Y':return 366*3+5;case 'ALL':return 1500;default:return 93;} }
  function calcRollingHigh(data, N){
    if(!data.length) return {rh:null};
    const lastIdx = data.length-2; if(lastIdx<0) return {rh:null};
    const start = Math.max(0, lastIdx-(N-1));
    let rh=-Infinity; for(let i=start;i<=lastIdx;i++){ if(data[i].close>rh) rh=data[i].close; }
    return { rh: isFinite(rh)?rh:null };
  }
  
  // âœ¨ NEW: ç¨ç«‹å‡½å¼è¨ˆç®—å³æ™‚è§¸ç™¼åƒ¹ï¼ˆç”¨ä»¥ç¢ºä¿å³æ™‚ç‡ˆè™Ÿèˆ‡ç·šåœ–åŒæ­¥ï¼‰
  function calculateLiveTriggers(liveDataFull){
      const N_in  = Number($('#entryLookback').value);
      const ddIn  = Number($('#entryPullback').value)/100;
      const N_out = Number($('#exitLookback').value);
      const ddOut = Number($('#exitDrawdown').value)/100;
      const ddSecOut = Number($('#exitSecondPeakDrawdown').value)/100; // NEW
      
      const {rh: rh_entry} = calcRollingHigh(liveDataFull, N_in);
      const {rh: rh_exit} = calcRollingHigh(liveDataFull, N_out);

      // å³æ™‚ RH entry/trigger
      liveRH_entry = rh_entry;
      liveTrigger_entry = (rh_entry!=null)? rh_entry*(1-ddIn): null;
      
      // å³æ™‚ RH exit/trigger - å³æ™‚ç·šåœ–åªç¹ªè£½æœ€è¿‘é«˜é»å›è½çš„è§¸ç™¼åƒ¹ (Exit 1)
      liveRH_exit  = rh_exit;
      liveTrigger_exit = (rh_exit!=null)? rh_exit*(1-ddOut): null;
      
      // æ³¨æ„ï¼šç¬¬äºŒé«˜é»çš„è§¸ç™¼åƒ¹ä¸ç•«åœ¨å³æ™‚åœ–ä¸Šï¼Œå› ç‚ºåœ–ä¸Šåªç•«å…©æ¢ç·šï¼Œä¸” RH å‡ºå ´ç·šæ›´å¸¸ç”¨ä½œè¦–è¦ºåƒè€ƒã€‚
  }

  function renderLiveChart(){
    if (typeof Chart === 'undefined') return;
    const ctx = $('#liveChart').getContext('2d');
    const labels = liveData.map(x => iso(x.time));
    const price  = liveData.map(x => x.close);
    // ä½¿ç”¨å·²æ›´æ–°çš„ liveTrigger_entry / liveTrigger_exit
    const rhIn   = (liveRH_entry!=null)? labels.map(_=> liveRH_entry): labels.map(_=> null);
    const triIn  = (liveTrigger_entry!=null)? labels.map(_=> liveTrigger_entry): labels.map(_=> null);
    const triOut = (liveTrigger_exit!=null)? labels.map(_=> liveTrigger_exit): labels.map(_=> null);
    const mkt    = (lastLivePrice!=null)? labels.map(_=> lastLivePrice): labels.map(_=> null);

    if (liveChart) liveChart.destroy();
    if (_resizeHold) { requestAnimationFrame(renderLiveChart); return; }

    requestAnimationFrame(() => {
      liveChart = new Chart(ctx,{
        type:'line',
        data:{ labels,
          datasets:[
            { label:`${currentSymbol} æ”¶ç›¤(1D)`, data:price, pointRadius:0, borderColor:cPrice },
            { label:'è¿‘ N æ—¥é«˜é»', data:rhIn, borderDash:[6,4], pointRadius:0, borderColor:cRH },
            { label:'è§¸ç™¼åƒ¹ï¼ˆé€²å ´ï¼‰', data:triIn, borderDash:[3,3], pointRadius:0, borderColor:cTrigger },
            { label:'è§¸ç™¼åƒ¹ï¼ˆå‡ºå ´ï¼‰', data:triOut, borderDash:[3,3], pointRadius:0, borderColor:cTriggerExit },
            { label:'å³æ™‚ç¾åƒ¹', data:mkt, borderDash:[1,1], pointRadius:0, borderColor:'#7dd3fc' }
          ]
        },
        options:{
          responsive:true, resizeDelay:200, animation:false, maintainAspectRatio:false,
          interaction:{mode:'index',intersect:false},
          plugins:{ legend:{position:'top', labels:{color:'#EDEFF5'}},
            tooltip:{callbacks:{label:(c)=> c.dataset.label+': '+fmt(c.parsed.y,2)}} },
          scales:{
            x:{ticks:{color:'#C9D3EA', maxRotation:0,autoSkip:true,maxTicksLimit:12}, grid:{color:'#223047'}},
            y:{beginAtZero:false, ticks:{color:'#C9D3EA'}, grid:{color:'#223047'}}
          }
        }
      });
    });
  }

  function updateLiveInfoUI(){
    $('#live_price').textContent = (lastLivePrice!=null)? lastLivePrice.toLocaleString(undefined,{maximumFractionDigits:2}) : 'â€”';
    $('#live_rh').textContent    = (liveRH_entry!=null)? liveRH_entry.toLocaleString(undefined,{maximumFractionDigits:2}) : 'â€”';
    $('#live_trigger').textContent = (liveTrigger_entry!=null)? liveTrigger_entry.toLocaleString(undefined,{maximumFractionDigits:2}) : 'â€”';
    $('#live_rh_exit').textContent = (liveRH_exit!=null)? liveRH_exit.toLocaleString(undefined,{maximumFractionDigits:2}) : 'â€”';
    $('#live_trigger_exit').textContent = (liveTrigger_exit!=null)? liveTrigger_exit.toLocaleString(undefined,{maximumFractionDigits:2}) : 'â€”';
  }

  async function refreshLiveDaily(){
    try{
      const rangeCode = $('#range') ? $('#range').value : '3M';
      const rangeDays = getRangeDays(rangeCode);
      const N_in  = Number($('#entryLookback').value);
      const N_out = Number($('#exitLookback').value);
      const need = (rangeCode==='ALL')?1500:Math.min(1500, rangeDays + Math.max(N_in,N_out) + 10);
      const rows = await fetchBinanceKlines(currentSymbol, need);
      liveDataFull = rows;

      // é‡æ–°è¨ˆç®—å³æ™‚è§¸ç™¼åƒ¹
      calculateLiveTriggers(liveDataFull);

      if(rangeCode==='ALL'){ liveData = liveDataFull.slice(); }
      else { const cut=Math.min(rangeDays, liveDataFull.length); liveData = liveDataFull.slice(liveDataFull.length-cut); }

      if(lastLivePrice==null && liveDataFull.length){ lastLivePrice = liveDataFull[liveDataFull.length-1].close; }

      updateLiveInfoUI(); renderLiveChart();
      checkTriggers(lastLivePrice); // é‡æ–°è¨ˆç®—å¾Œç«‹å³æª¢æŸ¥
      $('#live_note').textContent = `å·²è¼‰å…¥ ${currentSymbol} çš„ Binance 1D K ç·šï¼ˆå€é–“ï¼š${rangeCode}ï¼‰ã€‚è¿‘ N/M æ—¥ RH ä¸å«ç•¶æ—¥ï¼›WS ç§’ç´šæ›´æ–°ç¾åƒ¹ã€‚`;
    }catch(err){ console.error(err); $('#live_note').textContent='ç„¡æ³•è¼‰å…¥ Binance K ç·šï¼ˆå¯èƒ½ç¶²è·¯æˆ– CORSï¼‰ã€‚'; }
  }

  function startBinanceWS(){
    stopBinanceWS();
    try{
      const stream = `${currentSymbol.toLowerCase()}@miniTicker`;
      ws = new WebSocket(`wss://stream.binance.com:9443/ws/${stream}`);
      ws.onmessage = (ev)=>{
        try{
          const msg=JSON.parse(ev.data);
          const p=Number(msg.c);
          if(isFinite(p)){
            lastLivePrice=p; updateLiveInfoUI(); checkTriggers(p);
            const now=Date.now();
            if (liveChart && liveChart.data && Array.isArray(liveChart.data.labels) && (now-lastWSUpdate)>=250){
              lastWSUpdate=now;
              const idx=liveChart.data.datasets.findIndex(d=>d.label==='å³æ™‚ç¾åƒ¹');
              if(idx>=0){
                const len=liveChart.data.labels.length||0;
                if(len>0){
                  liveChart.data.datasets[idx].data = Array(len).fill(p);
                  liveChart.update('none');
                }
              }
            }
          }
        }catch(_){}
      };
    }catch(_){}
  }
  function stopBinanceWS(){ if(ws){ try{ws.close();}catch(_){} ws=null; } }
  function bindLiveAutoRefresh(){ setInterval(refreshLiveDaily, 5*60*1000); }
  async function initLiveModule(){ await refreshLiveDaily(); startBinanceWS(); bindLiveAutoRefresh(); }
  $('#symbol').addEventListener('change', async (e)=>{ currentSymbol=e.target.value||'BTCUSDT'; lastLivePrice=null; await refreshLiveDaily(); startBinanceWS(); });
  $('#range').addEventListener('change', async ()=>{ await refreshLiveDaily(); if(liveChart&& lastLivePrice!=null){ const idx=liveChart.data.datasets.findIndex(d=>d.label==='å³æ™‚ç¾åƒ¹'); if(idx>=0){ const len=liveChart.data.labels.length||0; if(len>0){ liveChart.data.datasets[idx].data = Array(len).fill(lastLivePrice); liveChart.update('none'); } } } });

  /* ========= æç¤ºéŸ³èˆ‡ç‡ˆè™Ÿï¼šåˆ†é›¢å…©å€‹é–‹é—œ ========= */
  let audioCtx=null;
  let alertLoop = null;
  let entryAlertActive=false, exitAlertActive=false;

  // æ–°ï¼šå…©å€‹ç¨ç«‹è²éŸ³é–‹é—œ
  let soundEntryEnabled = true;
  let soundExitEnabled  = true;

  function ensureAudio(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    }
    if(audioCtx.state==='suspended'){ audioCtx.resume(); }
  }
  function playBeep(kind='entry'){
    if(kind==='entry' && !soundEntryEnabled) return;
    if(kind==='exit'  && !soundExitEnabled)  return;
    ensureAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    // é€²å ´é‡‘è‰²è¼ƒä½éŸ³ï¼Œå‡ºå ´ç´«è‰²è¼ƒé«˜éŸ³
    osc.frequency.value = (kind==='entry')? 660 : 880;
    gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime+0.01);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.18);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime+0.2);
  }
  function startAlertLoop(){
    if(alertLoop) return;
    alertLoop = setInterval(()=>{
      // è‹¥å…©å€‹éƒ½é—œï¼Œç›´æ¥åœæ­¢å¾ªç’°
      if(!(soundEntryEnabled || soundExitEnabled)){ stopAlertLoop(); return; }
      let didAny = false;
      if(entryAlertActive && soundEntryEnabled){ playBeep('entry'); didAny = true; }
      if(exitAlertActive  && soundExitEnabled ){ playBeep('exit');  didAny = true; }
      if(!didAny){ stopAlertLoop(); }
    }, 1000);
  }
  function stopAlertLoop(){ if(alertLoop){ clearInterval(alertLoop); alertLoop=null; } }

  function setLamp(selector, active, type){
    const el = document.querySelector(selector);
    if(!el) return;
    el.classList.remove('on','entry','exit');
    if(active){
      el.classList.add('on', (type==='entry'?'entry':'exit'));
    }
  }

  function checkTriggers(price){
    if(price==null) return;

    // é€²å ´ï¼šç¾åƒ¹ <= è§¸ç™¼åƒ¹ï¼ˆæ†äº® / æ¯ç§’å¾ªç’°ï¼‰
    if(liveTrigger_entry!=null){
      if(price <= liveTrigger_entry){
        if(!entryAlertActive){
          entryAlertActive=true;
          setLamp('#lamp_entry', true, 'entry');
          playBeep('entry'); startAlertLoop();
        }
      }else if(price > liveTrigger_entry*1.002){
        entryAlertActive=false;
        setLamp('#lamp_entry', false);
        if(!exitAlertActive) stopAlertLoop();
      }
    }

    // å‡ºå ´ï¼šç¾åƒ¹ <= è§¸ç™¼åƒ¹ï¼ˆæ†äº® / æ¯ç§’å¾ªç’°ï¼‰
    // å³æ™‚ç‡ˆè™Ÿä»åªåƒè€ƒ RH-based çš„ liveTrigger_exit
    if(liveTrigger_exit!=null){
      if(price <= liveTrigger_exit){
        if(!exitAlertActive){
          exitAlertActive=true;
          setLamp('#lamp_exit', true, 'exit');
          playBeep('exit'); startAlertLoop();
        }
      }else if(price > liveTrigger_exit*1.002){
        exitAlertActive=false;
        setLamp('#lamp_exit', false);
        if(!entryAlertActive) stopAlertLoop();
      }
    }
  }

  // ä½¿ç”¨è€…æ§åˆ¶å…©å€‹æç¤ºéŸ³
  $('#toggleSoundEntry').addEventListener('change', e=>{
    soundEntryEnabled = e.target.checked;
    if(soundEntryEnabled && entryAlertActive){ ensureAudio(); playBeep('entry'); startAlertLoop(); }
    if(!(soundEntryEnabled || soundExitEnabled)) stopAlertLoop();
  });
  $('#toggleSoundExit').addEventListener('change', e=>{
    soundExitEnabled = e.target.checked;
    if(soundExitEnabled && exitAlertActive){ ensureAudio(); playBeep('exit'); startAlertLoop(); }
    if(!(soundEntryEnabled || soundExitEnabled)) stopAlertLoop();
  });

  // ä»»ä½•é»æ“Šéƒ½å˜—è©¦è§£é– AudioContextï¼ˆè¡Œå‹•è£ç½®ï¼‰
  window.addEventListener('click', ensureAudio, {once:true});

  /* ========= ä¸Šå‚³å›æ¸¬ä¸»æµç¨‹ ========= */
  window.addEventListener('error',(e)=>{ const el=$('#status'); if(el) el.textContent='éŒ¯èª¤ï¼š'+(e.message||e.error||e.filename||'æœªçŸ¥éŒ¯èª¤'); });
  let df=null, chart, lastRes=null, lastData=null, lastYears=null;

  function toCSV(rows, headerKeys, headerNames){
    const esc = v=>{ const s=(v==null)?'':String(v); return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"': s; };
    const lines=[]; if(headerNames&&headerNames.length) lines.push(headerNames.map(esc).join(','));
    for(const r of rows){ const line = headerKeys.map(k=> esc(typeof k==='function'? k(r): r[k])); lines.push(line.join(',')); }
    return '\uFEFF'+lines.join('\n');
  }
  function downloadCSV(filename, csvString){
    const blob=new Blob([csvString],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },0);
  }

  async function exportChartPng(){
    if(!lastRes) return;
    const scrollbox = $('#entriesScrollbox');
    const originalMaxHeight = scrollbox.style.maxHeight;
    const originalOverflow = scrollbox.style.overflow;
    scrollbox.style.maxHeight = 'none';
    scrollbox.style.overflow = 'visible';

    const targetElement = $('#resultCard');
    try {
      const canvas = await html2canvas(targetElement, { scale: 2, useCORS: true, backgroundColor: '#0A1221' });
      scrollbox.style.maxHeight = originalMaxHeight; scrollbox.style.overflow = originalOverflow;
      const dataURL = canvas.toDataURL('image/png');
      const a = document.createElement('a'); a.href = dataURL; a.download = `backtest_result_${iso(new Date())}.png`;
      document.body.appendChild(a); a.click(); setTimeout(()=>{ document.body.removeChild(a); }, 0);
    } catch (error) {
      scrollbox.style.maxHeight = originalMaxHeight; scrollbox.style.overflow = originalOverflow;
      console.error('PNG æˆªåœ–å¤±æ•—:', error); alert('PNG æˆªåœ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è¡¨æ ¼å…§å®¹ã€‚');
    }
  }

  // **ä¿®æ­£å¾Œçš„ readAnyTabular å‡½å¼**
  async function readAnyTabular(file){
    const name=(file.name||'').toLowerCase();
    if(name.endsWith('.csv')){
      if(typeof XLSX==='undefined') throw new Error('SheetJS æœªè¼‰å…¥');
      const text=await file.text();
      // ä½¿ç”¨ CSV å°ˆç”¨è§£æå™¨ã€‚header:1 å’Œ raw:true æœ‰åŠ©æ–¼æ•¸å­—å­—ä¸²çš„è§£æã€‚
      const aoa = XLSX.utils.sheet_to_json(XLSX.read(text, {type:'string'}).Sheets.Sheet1, {header:1, raw:true});
      if(!aoa || !aoa.length) throw new Error('CSV è§£æå¾Œç„¡æ•¸æ“š');
      return aoa;
    } else {
      if(typeof XLSX==='undefined') throw new Error('SheetJS æœªè¼‰å…¥');
      const ab=await file.arrayBuffer();
      const wb=XLSX.read(ab,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      if(!ws) throw new Error('æ‰¾ä¸åˆ°ç¬¬ä¸€å€‹å·¥ä½œè¡¨');
      const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
      return rows;
    }
  }

  function pickCol(headers,candidates){
    const map={}; headers.forEach((h,i)=> map[String(h||'').trim()]=i);
    for(const c of candidates) if(map[c]!=null) return map[c];
    const lower={}; headers.forEach((h,i)=> lower[String(h||'').trim().toLowerCase()]=i);
    for(const c of candidates){ const k=String(c).toLowerCase(); if(lower[k]!=null) return lower[k]; }
    return -1;
  }

  // **ä¿®æ­£å¾Œçš„ toNumberClean å‡½å¼**
  function toNumberClean(v){
    // å¦‚æœ SheetJS å·²ç¶“è§£æç‚ºæ•¸å­—ï¼Œç›´æ¥å›å‚³
    if(typeof v==='number' && isFinite(v)) return v; 
    
    if(v==null||v==='') return NaN;
    if(typeof v==='number') return v;

    if(typeof v==='string'){ 
      // æ¸…é™¤é€—è™Ÿã€ç™¾åˆ†è™Ÿï¼Œä¸¦ç§»é™¤å°¾éš¨çš„éæ•¸å­—/é»å­—å…ƒï¼ˆå¦‚ 'K'ï¼‰
      let s=v.replace(/,/g,'').replace(/%/g,'').trim(); 
      // å˜—è©¦ç§»é™¤å°¾éš¨çš„éæ•¸å­—å­—å…ƒï¼Œä¾‹å¦‚ "5.80K" -> "5.80"
      s = s.replace(/[^0-9.]+$/, '');
      return Number(s); 
    }
    return Number(v);
  }

  // **ä¿®æ­£å¾Œçš„ parseRows å‡½å¼**
  function parseRows(rows){
    if(!rows||!rows.length) throw new Error('å·¥ä½œè¡¨æ²’æœ‰è³‡æ–™');
    const headers=rows[0].map(x=> String(x||'').trim());

    // ç”±æ–¼æ‚¨çš„æª”æ¡ˆæ¨™é¡Œæ˜¯ä¸­æ–‡ï¼Œç¢ºä¿æˆ‘å€‘èƒ½æ‰¾åˆ°å®ƒå€‘
    const dateIdx = pickCol(headers,['æ—¥æœŸ','date','Date','DATE','æ™‚é–“','Time','Datetime']);
    const closeIdx= pickCol(headers,['æ”¶å¸‚','æ”¶ç›¤','æ”¶ç›¤åƒ¹','Close','close','Adj Close','Adj close','æ”¶ç›¤åƒ¹(USD)']);

    // å°‹æ‰¾ã€Œä½ã€æ¬„ï¼Œæ‰¾ä¸åˆ°å°±è¿”å› -1
    let lowIdx  = pickCol(headers,['ä½','æœ€ä½','æœ€ä½åƒ¹','Low','low','Low Price','Low price']);

    if(dateIdx===-1||closeIdx===-1) throw new Error('æ‰¾ä¸åˆ°æ¬„ä½ï¼ˆéœ€ã€Œæ—¥æœŸã€ã€Œæ”¶å¸‚ã€ï¼‰');

    const out=[];
    for(let i=1;i<rows.length;i++){
      const r=rows[i]; if(!r) continue;
      const d=r[dateIdx]; const c=r[closeIdx]; if(d==null||c==null||c==='') continue;

      let dt;
      if(typeof d==='number'){ dt=new Date(Math.round((d-25569)*86400*1000)); }
      else { dt=new Date(d); }

      const close=toNumberClean(c);
      const lowVal = (lowIdx>-1) ? toNumberClean(r[lowIdx]) : NaN;

      if(!isNaN(dt.getTime())&&isFinite(close)){
        out.push({date:dt, close, low: (isFinite(lowVal)? lowVal : null)});
      }
    }
    out.sort((a,b)=> a.date-b.date);
    return out;
  }

  function filterYears(data, years){
    if(!data.length) return [];
    const end=data[data.length-1].date;
    const start=new Date(end); start.setFullYear(start.getFullYear()-years);
    return data.filter(x=> x.date>=start && x.date<=end);
  }

  // âœ¨ MODIFIED: æ»¾å‹•é«˜é»è¨ˆç®—ï¼ŒåŒæ™‚æ‰¾å‡ºæœ€é«˜é» (RH) å’Œæ¬¡é«˜é» (SRH)
  function rollingHighPrevWithIdx(arr, win){
    const n=arr.length; 
    const highs=new Array(n).fill(null); 
    const idxs=new Array(n).fill(null);
    const secondHighs=new Array(n).fill(null);

    for(let i=0;i<n;i++){
        if (i===0) continue; 

        let rh = -Infinity;
        let srh = -Infinity; 
        let rhIdx = null;
        
        const start = Math.max(0, i - win); 

        for(let j=start; j < i; j++){
            const price = arr[j];
            if(price > rh){
                srh = rh; // åŸä¾†çš„ rh é™ç‚º srh
                rh = price;
                rhIdx = j;
            } else if (price > srh) {
                srh = price;
            }
        }
        
        highs[i] = isFinite(rh) ? rh : null;
        idxs[i] = (rhIdx!==null) ? rhIdx : null;
        secondHighs[i] = isFinite(srh) && srh !== rh ? srh : null; // ç¢ºä¿ srh ä¸ç­‰æ–¼ rh
    }
    
    return {highs, idxs, secondHighs};
  }
  function quarterKey(d){ const y=d.getFullYear(); const q=Math.floor(d.getMonth()/3)+1; return y+'-Q'+q; }
  
  // âœ¨ NEW: çµ±ä¸€ç²å–åƒæ•¸çš„å‡½å¼
  function getBacktestParams() {
    return {
        years: Number($('#years').value),
        entryLookback: Number($('#entryLookback').value),
        entryPullback: Number($('#entryPullback').value) / 100,
        exitLookback: Number($('#exitLookback').value),
        exitDrawdown: Number($('#exitDrawdown').value) / 100,
        exitSecondPeakDrawdown: Number($('#exitSecondPeakDrawdown').value) / 100, // âœ¨ NEW: æ¬¡é«˜å›è½
        exitSellPct: Number($('#exitSellPct').value),
        leverage: Number($('#lev').value),
        margin: Number($('#margin').value),
        lotUSD: Number($('#lot').value),
        maxPerQuarter: Number($('#maxPerQ').value),
        exitMaxPerQuarter: Number($('#maxExitPerQ').value),
        exitNonNegRoi: $('#exitNonNegRoi').checked,
        exitAboveAvgOnly: $('#exitAboveAvgOnly').checked,
        safetyOn: $('#safetyMode').value === 'on',
        safetyFloorPct: Number($('#safetyFloor').value),
        maxNotional: Number($('#lev').value) * Number($('#margin').value)
    };
  }

  // âœ¨ MODIFIED: æ¨¡æ“¬å‡½å¼åŠ å…¥ç¬¬äºŒé«˜é»é‚è¼¯
  function simulate(data, params){
    const prices=data.map(x=> x.close);
    const {highs: prevHighEntry} = rollingHighPrevWithIdx(prices, params.entryLookback);
    // ç²å– RH, RH Index å’Œ Second RH (SRH)
    const {highs: prevHighExit,  idxs: prevHighExitIdx, secondHighs: prevSecondHighExit}  = rollingHighPrevWithIdx(prices, params.exitLookback);

    const entries=[];
    const path = data.map(x=> ({ æ—¥æœŸ:x.date, æ”¶å¸‚:x.close, avg_price:NaN, position_btc:0, equity:params.margin, liq_price:null, safetyPct:null }));

    const maxNotional = params.maxNotional;
    let cumNotional=0, posBTC=0, avgPrice=NaN, realized=0;
    let perQ={}, perQExit={}, nEntry=0, nExit=0, liquidated=false, mdd=0, peakEquity=-1e18, pendingForce=false;
    let lastPeakPrice = -1; // ç”¨æ–¼å…§éƒ¨è¿½è¹¤ï¼Œä¸å†ä½œç‚ºä¸»è¦å‡ºå ´é‚è¼¯

    for(let i=0;i<data.length;i++){
      if(liquidated) break;
      const p = prices[i];
      const qk = quarterKey(data[i].date);

      if(pendingForce && posBTC>0){
        const realizedGain = posBTC * (p - avgPrice);
        realized += realizedGain;
        posBTC=0; avgPrice=NaN; cumNotional=0; pendingForce=false; nExit++;
        entries.push({ é¡å‹:'å¼·åˆ¶å…¨å‡º', æ—¥æœŸ:data[i].date, åƒ¹æ ¼:p, æ¯”ä¾‹:100,
          Realized_Gain: realizedGain, Cumulative_Profit: realized, ROI_USDT: 0, ROI_PCT: -100, å€‰ä½æ§“æ¡¿å€æ•¸: null });
      }

      const equityNow = realized + (isFinite(avgPrice)? (p-avgPrice)*posBTC: 0) + params.margin;
      if(equityNow <= 0){
        liquidated=true;
        entries.push({ é¡å‹:'çˆ†å€‰', æ—¥æœŸ:data[i].date, åƒ¹æ ¼:p, æ¯”ä¾‹:100,
          Realized_Gain: -(equityNow - params.margin),
          Cumulative_Profit: realized - (equityNow - params.margin),
          ROI_USDT: -params.margin, ROI_PCT: -100, å€‰ä½æ§“æ¡¿å€æ•¸: null });
        break;
      }

      const phOut = prevHighExit[i];      // æœ€è¿‘é«˜é» (RH)
      const srhOut = prevSecondHighExit[i]; // ç¬¬äºŒé«˜é» (SRH)
      const phOutIdx = prevHighExitIdx[i];
      const phOutDate = (phOutIdx!=null && phOutIdx>=0)? data[phOutIdx].date : null;

      let isExitTriggered = false;
      let exitReason = '';
      let triggerPrice = null;
      let refHighPrice = null;
      let refHighDate = null;
      let refTriggerPrice = null;

      if(posBTC>0){
        // 1. Exit 1: æœ€è¿‘é«˜é»å›è½è§¸ç™¼ (RH Drawdown)
        if(isFinite(phOut) && phOut!=null){
          const triggerOut1 = phOut * (1 - params.exitDrawdown);
          if(p <= triggerOut1){
            isExitTriggered = true;
            exitReason = `å›è½è§¸ç™¼ (RH ${Math.round(params.exitDrawdown*100)}%)`;
            refHighPrice = phOut;
            refHighDate = phOutDate;
            refTriggerPrice = triggerOut1;
          }
        }
        
        // 2. Exit 2: ç¬¬äºŒé«˜é»å›è½è§¸ç™¼ (SRH Drawdown)
        if(!isExitTriggered && isFinite(srhOut) && srhOut!=null){
          const triggerOut2 = srhOut * (1 - params.exitSecondPeakDrawdown);
          if(p <= triggerOut2){
            isExitTriggered = true;
            exitReason = `è·Œç ´ç¬¬äºŒé«˜é» (SRH ${Math.round(params.exitSecondPeakDrawdown*100)}%)`;
            // è¨˜éŒ„ SRH çš„æ•¸æ“š
            // æ³¨æ„ï¼šæˆ‘å€‘æ²’æœ‰ SRH çš„æ—¥æœŸç´¢å¼•ï¼Œæ‰€ä»¥æ—¥æœŸç´€éŒ„ RH çš„ï¼ˆæˆ–ç•™ç©ºï¼‰
            refHighPrice = srhOut; 
            refHighDate = 'â€”'; 
            refTriggerPrice = triggerOut2;
          }
        }
        
        // 3. åŸä¾†çš„ lastPeakPrice é‚è¼¯ï¼ˆåˆªé™¤ï¼Œé¿å…æ··äº‚ï¼‰
      }

      if(isExitTriggered && posBTC>0){
        const usedExit = perQExit[qk] || 0;
        const roiGate = params.exitNonNegRoi ? (equityNow - params.margin >= 0) : true;
        const avgGate = params.exitAboveAvgOnly ? (!isFinite(avgPrice) || p >= avgPrice) : true;

        if(usedExit < params.exitMaxPerQuarter && roiGate && avgGate){
          const sellFrac = Math.min(1, Math.max(0, params.exitSellPct/100));
          const sellBTC  = posBTC * sellFrac;

          if(sellBTC>0){
            const realizedGain = sellBTC * (p - avgPrice);
            realized += realizedGain;

            posBTC  -= sellBTC;
            cumNotional = (posBTC>0)? cumNotional * (posBTC / (posBTC + sellBTC)): 0;

            perQExit[qk] = usedExit + 1; nExit++;
            const equityAfterExit = realized + (isFinite(avgPrice)? (p-avgPrice)*posBTC:0) + params.margin;
            const notionalAfterExit = posBTC * p;
            const levXExit = (equityAfterExit>0)? (notionalAfterExit/equityAfterExit) : null;

            entries.push({
              é¡å‹: exitReason + ` (${Math.round(params.exitSellPct)}%)`,
              æ—¥æœŸ:data[i].date, åƒ¹æ ¼:p, åƒè€ƒé«˜é»: refHighPrice, åƒè€ƒé«˜é»æ—¥æœŸ: refHighDate, è§¸ç™¼åƒ¹: refTriggerPrice,
              åç›®éƒ¨ä½USD: -sellBTC * p, ç´¯ç©åç›®USD: cumNotional, å€‰ä½å‡åƒ¹: avgPrice, æŒå€‰åƒ¹å€¼USD: notionalAfterExit, å‡ºå ´æ¯”ä¾‹: Math.round(params.exitSellPct),
              Realized_Gain: realizedGain, Cumulative_Profit: realized,
              ROI_USDT: (equityAfterExit - params.margin), ROI_PCT: (equityAfterExit/params.margin - 1) * 100, å€‰ä½æ§“æ¡¿å€æ•¸: levXExit
            });
            if(posBTC===0){ avgPrice=NaN; lastPeakPrice = -1; }
          }
        }
      }

      const phIn = prevHighEntry[i];
      const phInIdx = prevHighEntryIdx[i];
      const phInDate = (phInIdx!=null && phInIdx>=0)? data[phInIdx].date : null;
      if(isFinite(phIn) && phIn!=null){
        const triggerIn = phIn * (1 - params.entryPullback);
        const used = perQ[qk]||0;
        if(p <= triggerIn && cumNotional < maxNotional && used < params.maxPerQuarter){
          const addNotional = Math.min(params.lotUSD, maxNotional - cumNotional);
          if(addNotional>0){
            const addBTC = addNotional / p;
            const newPos = posBTC + addBTC;
            const newAvg = (posBTC>0)? (avgPrice*posBTC + p*addBTC)/newPos : p;
            avgPrice=newAvg; posBTC=newPos; cumNotional += addNotional; perQ[qk]=used+1; nEntry++;
            const levX = (params.margin + (p-newAvg)*newPos)>0 ? (newPos*p) / (params.margin + (p-newAvg)*newPos) : null;
            const equityAfterEntry = (params.margin + (p - newAvg)*newPos) + realized; const notionalAfterEntry = newPos * p;
            entries.push({
              é¡å‹:'é€²å ´', æ—¥æœŸ:data[i].date, åƒ¹æ ¼:p, åƒè€ƒé«˜é»: phIn, åƒè€ƒé«˜é»æ—¥æœŸ: phInDate, è§¸ç™¼åƒ¹: triggerIn,
              åç›®éƒ¨ä½USD:addNotional, ç´¯ç©åç›®USD:cumNotional, å€‰ä½å‡åƒ¹:newAvg, æŒå€‰åƒ¹å€¼USD:notionalAfterEntry,
              Realized_Gain: 0, Cumulative_Profit: realized,
              ROI_USDT:(equityAfterEntry - params.margin), ROI_PCT:(equityAfterEntry/params.margin - 1) * 100, å€‰ä½æ§“æ¡¿å€æ•¸:levX
            });
          }
        }
      }

      // è¿½è¹¤æœ€é«˜é»
      if (isFinite(phOut) && phOut!=null && p > phOut) { lastPeakPrice = p; }
      if(posBTC === 0){ lastPeakPrice = -1; }

      const equity = realized + (isFinite(avgPrice)? (p-avgPrice)*posBTC:0) + params.margin;
      const liq = (posBTC>0 && isFinite(avgPrice))? (avgPrice - (params.margin/posBTC)) : null;
      path[i].avg_price = avgPrice; path[i].position_btc = posBTC; path[i].equity = equity; path[i].liq_price = liq;
      path[i].safetyPct = (liq!=null)? ((p - liq)/p*100) : null;

      if(equity > peakEquity) peakEquity = equity;
      const dd = peakEquity - equity; if(dd > mdd) mdd = dd;

      if(params.safetyOn && posBTC>0 && path[i].safetyPct!=null && path[i].safetyPct < params.safetyFloorPct){ pendingForce = true; }
    }

    const equityEnd = liquidated ? 0 : path[path.length-1].equity;
    const roi = liquidated ? -1 : (equityEnd/params.margin - 1);
    const mddPct = mdd / params.margin * 100;
    const safetyEnd = path[path.length-1].safetyPct;

    return { entries, path, liquidated, roi, equityEnd, mddPct, nEntry, nExit, safetyEnd };
  }

  function renderSummary(data, res, years){
    const head1 = $('#summaryTable1 thead');
    const body1 = $('#summaryTable1 tbody');
    const head2 = $('#summaryTable2 thead');
    const body2 = $('#summaryTable2 tbody');
    head1.innerHTML = ''; body1.innerHTML = ''; head2.innerHTML = ''; body2.innerHTML = '';

    const liqClass = res.liquidated ? 'bad' : 'ok';
    const roiClass = res.roi > 0 ? 'data-ok' : (res.roi < 0 ? 'data-bad' : '');

    const metrics1Keys = ['æ¨£æœ¬ç­†æ•¸','å€é–“','é€²å ´æ¬¡æ•¸','å‡ºå ´æ¬¡æ•¸','æ˜¯å¦çˆ†å€‰'];
    const metrics1Values = [
      data.length || 'â€”',
      data.length ? (iso(data[0].date)+' â†’ '+iso(data[data.length-1].date)+'ï¼ˆè¿‘ '+years+' å¹´ï¼‰') : 'â€”',
      res.nEntry, res.nExit,
      `<span class="traffic-light ${liqClass}"></span> ${res.liquidated ? 'çˆ†å€‰' : 'å®‰å…¨'}`
    ];

    const metrics2Keys = ['æœŸæœ«æ·¨å€¼ (USD)','ROIï¼ˆä¿è­‰é‡‘ï¼‰','æœ€å¤§å›æ’¤ï¼ˆMDDï¼‰','æœŸæœ«å®‰å…¨é‚Šéš›'];
    const metrics2Values = [
      fmt(res.equityEnd,2),
      (res.roi==null)?'â€”':(res.roi*100).toFixed(2)+'%',
      (res.mddPct!=null)?res.mddPct.toFixed(2)+'%':'â€”',
      (res.safetyEnd!=null)?res.safetyEnd.toFixed(2)+'%':'â€”'
    ];
    const metrics2Classes = ['', roiClass, 'data-bad', ''];

    head1.innerHTML = '<tr>'+metrics1Keys.map(k=>`<th>${k}</th>`).join('')+'</tr>';
    body1.innerHTML = '<tr>'+metrics1Values.map(v=>`<td>${v}</td>`).join('')+'</tr>';

    head2.innerHTML = '<tr>'+metrics2Keys.map(k=>`<th>${k}</th>`).join('')+'</tr>';
    body2.innerHTML = '<tr>'+metrics2Values.map((v,i)=>`<td class="${metrics2Classes[i]||''}">${v}</td>`).join('')+'</tr>';

    renderAISuggestion(res, data.length > 0 ? (data[data.length-1].date - data[0].date) / (365.25 * 24 * 60 * 60 * 1000) : 1);
  }

  function renderAISuggestion(res, totalYears){
    const container = $('#aiAdviceContent');
    const margin = Number($('#margin').value);
    const theLev = Number($('#lev').value);
    const lot = Number($('#lot').value);
    const entryPullback = Number($('#entryPullback').value);
    const exitDrawdown = Number($('#exitDrawdown').value);
    const entryLookback = Number($('#entryLookback').value);

    const roiPct = res.roi * 100;
    const mddPct = res.mddPct;

    const annualRoiPct = (totalYears > 0 && isFinite(totalYears)) ? roiPct / totalYears : roiPct;
    const calmarRatio = (mddPct > 0) ? (annualRoiPct / mddPct) : (roiPct > 0 ? Infinity : 0);

    const nEntry = res.nEntry;
    const dataLength = lastData ? lastData.length : 0;

    let adviceType = 'ğŸ’¡ ä¸­æ€§è§€å¯Ÿ', adviceClass = 'warn', summary = '';
    let suggestions = [];

    if (res.liquidated) {
      adviceType = 'ğŸš¨ è‡´å‘½é¢¨éšªï¼šå·²çˆ†å€‰'; adviceClass = 'bad';
      summary = `ç­–ç•¥åœ¨æœ¬æ¬¡å›æ¸¬ä¸­å·²çˆ†å€‰ï¼Œé¢¨éšªéé«˜ã€‚`;
      suggestions.push(`å°‡æ§“æ¡¿å¾ **${theLev}Ã—** é™è‡³ **${Math.max(1, Math.floor(theLev*0.5))}Ã—**ã€‚`);
      suggestions.push(`å•Ÿç”¨å®‰å…¨é‚Šéš›ä¸¦å°‡ä¿è­‰é‡‘æé«˜åˆ°ç´„ ${fmt(margin*1.5,0)} USDã€‚`);
    } else if (calmarRatio > 1.5 && roiPct > 15) {
      adviceType = 'ğŸŒŸ ç¸¾æ•ˆå¼·å‹ / é«˜æ•ˆèƒ½'; adviceClass='ok';
      summary = `Calmar ${calmarRatio.toFixed(2)}ï¼Œé¢¨éšªèª¿æ•´å¾Œè¡¨ç¾å„ªç•°ã€‚`;
      suggestions.push(`åœ¨ç›¸åŒæ§“æ¡¿ä¸‹ï¼Œå¯å°‡å–®æ¬¡é€²å ´åç›®ä¸Šèª¿ 10â€“20%ï¼ˆç´„ ${fmt(lot*1.15,0)} USDï¼‰å†æ¸¬ã€‚`);
      suggestions.push(`ä¿ç•™ã€Œä½æ–¼å‡åƒ¹ä¸å‡ºå ´ã€ä»¥ç¶­æŒè¼ƒä½å›æ’¤ã€‚`);
    } else if (mddPct > 30 && calmarRatio < 0.5) {
      adviceType = 'âš ï¸ é«˜å›æ’¤ / ä½æ•ˆèƒ½'; adviceClass='bad';
      summary = `MDD ${mddPct.toFixed(2)}%ï¼ŒCalmar åä½ã€‚`;
      suggestions.push(`æé«˜å…¥å ´å›æª”ï¼ˆä¾‹ ${Math.min(30, entryPullback+5)}%ï¼‰ã€‚`);
      suggestions.push(`é™ä½å‡ºå ´å›è½é–€æª»ä»¥æ›´æ—©æ­¢ææˆ–é–åˆ©ã€‚`);
      suggestions.push(`é™ä½å–®æ¬¡é€²å ´åç›®ä»¥æ¸›å°‘æ³¢å‹•ã€‚`);
    } else if (nEntry < Math.max(5, dataLength/180)) {
      adviceType = 'ğŸŸ¡ äº¤æ˜“é »ç‡ä½'; adviceClass='warn';
      summary = 'é€²å ´æ¬¡æ•¸åå°‘ï¼Œå¯èƒ½éŒ¯å¤±æ©Ÿæœƒã€‚';
      suggestions.push(`ç¸®çŸ­é€²å ´è¦–çª—ï¼ˆä¾‹ ${Math.max(30, entryLookback-30)} å¤©ï¼‰ã€‚`);
      suggestions.push(`ä¸‹èª¿å…¥å ´å›æª”ï¼ˆä¾‹ ${Math.max(5, entryPullback-5)}%ï¼‰ã€‚`);
    } else {
      adviceType = 'ğŸ’¡ ä¸­ç­‰ç©©å¥ / å„ªåŒ–ç©ºé–“'; adviceClass='warn';
      summary = `ç¸½å ±é…¬ ${roiPct.toFixed(2)}%ï¼ŒCalmar ${calmarRatio.toFixed(2)}ï¼Œä»å¯å¾®èª¿æå‡ã€‚`;
      suggestions.push(`å…¥å ´å›æª” (${entryPullback}%) å»ºè­° â‰¥ å‡ºå ´å›è½ (${exitDrawdown}%) ä»¥ä¿ç•™ç·©è¡ã€‚`);
      suggestions.push(`ç¶­æŒã€Œä½æ–¼å‡åƒ¹ä¸å‡ºå ´ã€ä»¥æ§å›æ’¤ã€‚`);
      suggestions.push(`ä¸€æ¬¡åªèª¿ä¸€å€‹åƒæ•¸ï¼ˆÂ±5%ï¼‰è§€å¯Ÿ Calmar è®ŠåŒ–ã€‚`);
    }

    container.innerHTML = `
      <div class="advice-type ${adviceClass}">ã€${adviceType}ã€‘</div>
      <p style="margin:5px 0 5px;font-size:13px;color:var(--text);">${summary}</p>
      <h5 style="font-size:13px;color:var(--gold);margin:10px 0 5px;">å…·é«”è¡Œå‹•å»ºè­°ï¼š</h5>
      <ul>${suggestions.map(s=>`<li>${s}</li>`).join('')}</ul>
    `;
  }

  function renderEntriesTable(list){
    const head=$('#entriesTable thead tr'), body=$('#entriesTable tbody'); head.innerHTML=''; body.innerHTML='';
    const cols=['é¡å‹','æ—¥æœŸ','åƒ¹æ ¼','åƒè€ƒé«˜é»','åƒè€ƒé«˜é»æ—¥æœŸ','è§¸ç™¼åƒ¹','åç›®éƒ¨ä½USD','å€‰ä½å‡åƒ¹','æŒå€‰åƒ¹å€¼USD','å‡ºå ´æ¯”ä¾‹%','ROI(USDT)','ROI(%)','ç²åˆ©äº†çµUSD','ç´¯ç©ç²åˆ©USD','æœªå¯¦ç¾æç›ŠUSD'];
    cols.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; head.appendChild(th); });

    list.forEach(r=>{
      const tr=document.createElement('tr');
      const realizedDisplay = (r.é¡å‹.startsWith('é€²å ´') || r.é¡å‹.startsWith('çˆ†å€‰') || r.é¡å‹.startsWith('å¼·åˆ¶å…¨å‡º')) ? 'â€”' : fmt(r.Realized_Gain, 2);
      let unrealizedDisplay = 'â€”';
      if (!r.é¡å‹.startsWith('çˆ†å€‰') && !r.é¡å‹.startsWith('å¼·åˆ¶å…¨å‡º') && !r.é¡å‹.startsWith('å‡ºå ´')) {
        const unrealizedGain = r.ROI_USDT - r.Cumulative_Profit;
        unrealizedDisplay = fmt(unrealizedGain, 2);
      }

      [
        r.é¡å‹, iso(r.æ—¥æœŸ), fmt(r.åƒ¹æ ¼,2), fmt(r.åƒè€ƒé«˜é»,2), (r.åƒè€ƒé«˜é»æ—¥æœŸ? iso(r.åƒè€ƒé«˜é»æ—¥æœŸ): 'â€”'),
        fmt(r.è§¸ç™¼åƒ¹,2), fmt(r.åç›®éƒ¨ä½USD,0), fmt(r.å€‰ä½å‡åƒ¹,2), fmt(r.æŒå€‰åƒ¹å€¼USD,0),
        (r.å‡ºå ´æ¯”ä¾‹!=null? r.å‡ºå ´æ¯”ä¾‹+'%':'â€”'),
        fmt(r.ROI_USDT,2), (r.ROI_PCT!=null? r.ROI_PCT.toFixed(2)+'%':'â€”'),
        realizedDisplay, fmt(r.Cumulative_Profit, 2), unrealizedDisplay
      ].forEach(v=>{ const td=document.createElement('td'); td.textContent=v; tr.appendChild(td); });
      body.appendChild(tr);
    });
  }

  function renderChart(data, entries, path){
    if(typeof Chart==='undefined') return; const ctx=$('#chart').getContext('2d');
    const labels=data.map(x=> iso(x.date)); const price=data.map(x=> x.close);
    const lowLine=data.map(x=> (x.low!=null && isFinite(x.low))? x.low : null); 
    const avgLine=path.map(x=> isNaN(x.avg_price)? null: x.avg_price);
    const liqLine=path.map(x=> (x&&x.liq_price!=null)? x.liq_price: null);

    const labelsEntries = entries.map(e=> iso(e.æ—¥æœŸ));
    const entryFlags = entries.map(e=> e.é¡å‹.startsWith('é€²å ´'));
    const exitFlags  = entries.map(e=> e.é¡å‹.startsWith('å›è½è§¸ç™¼') || e.é¡å‹.startsWith('è·Œç ´ç¬¬äºŒé«˜é»') || e.é¡å‹.startsWith('å¼·åˆ¶å…¨å‡º')); // âœ¨ MODIFIED

    const scatterEntry = labels.map((_,i)=>{ const j=labelsEntries.indexOf(labels[i]); return (j>=0 && entryFlags[j]) ? price[i] : null; });
    const scatterExit  = labels.map((_,i)=>{ const j=labelsEntries.indexOf(labels[i]); return (j>=0 && exitFlags[j]) ? price[i] : null; });

    if(chart) chart.destroy();
    if (_resizeHold) { requestAnimationFrame(() => renderChart(data, entries, path)); return; }

    requestAnimationFrame(() => {
      chart = new Chart(ctx,{
        type:'line', data:{ labels,
          datasets:[
            { label:'æ”¶å¸‚', data:price, pointRadius:0, borderColor:cPrice },
            { label:'ä½ï¼ˆä¸Šå‚³ï¼‰', data:lowLine, pointRadius:0, borderColor:cLow }, 
            { label:'åŠ æ¬Šå¹³å‡åƒ¹', data:avgLine, borderDash:[6,4], pointRadius:0, borderColor:cAvg },
            { label:'çˆ†å€‰ç·šï¼ˆå‹•æ…‹ï¼‰', data:liqLine, borderDash:[2,2], pointRadius:0, borderColor:cLiq },
            { label:'é€²å ´é»', type:'scatter', data:scatterEntry, showLine:false, pointRadius:4, borderColor:cEntry, backgroundColor:cEntry, pointStyle:'circle' },
            { label:'å‡ºå ´é»', type:'scatter', data:scatterExit,  showLine:false, pointRadius:4, borderColor:cExit,  backgroundColor:cExit,  pointStyle:'rectRot' }
          ] },
        options:{
          responsive:true, resizeDelay:200, animation:false, maintainAspectRatio:false,
          interaction:{mode:'index',intersect:false},
          plugins:{ legend:{position:'top', labels:{color:'#EDEFF5'}}, tooltip:{callbacks:{label:(c)=> c.dataset.label+': '+fmt(c.parsed.y,2)}} },
          scales:{ x:{ticks:{color:'#C9D3EA',maxRotation:0,autoSkip:true,maxTicksLimit:12}, grid:{color:'#223047'}},
                  y:{beginAtZero:false, ticks:{color:'#C9D3EA'}, grid:{color:'#223047'}} }
        }
      });
    });
  }

  function computeIfReady(){
    if(!df||!df.length){ uiLog('å·²é¸æª”ï¼Œä½†æ²’æœ‰æœ‰æ•ˆè³‡æ–™åˆ—'); return; }
    
    const params = getBacktestParams(); // âœ¨ NEW: ä½¿ç”¨çµ±ä¸€åƒæ•¸ç²å–

    $('#maxNotional').value = params.maxNotional.toFixed(0);

    const cut = filterYears(df, params.years); if(!cut.length){ uiLog('æœŸé–“å…§æ²’æœ‰è³‡æ–™'); return; }
    const res = simulate(cut, params);

    lastRes=res; lastData=cut; lastYears=params.years;
    renderSummary(cut,res,params.years);
    renderEntriesTable(res.entries);
    renderChart(cut,res.entries,res.path);

    uiLog(`å®Œæˆï¼šé€²å ´ ${res.nEntry} æ¬¡ã€å‡ºå ´ ${res.nExit} æ¬¡${res.liquidated?'ï¼ˆå·²çˆ†å€‰ï¼‰':''}ï¼›æ¨£æœ¬ ${cut.length} ç­†`);
    $('#exportEntries').disabled = res.entries.length===0; $('#exportSummary').disabled = false;
    $('#exportChartPng').disabled = false;
  }

  function exportEntriesCSV(){
    if(!lastRes) return;
    const rows=lastRes.entries;
    const csv=toCSV(rows,
      ['é¡å‹','æ—¥æœŸ','åƒ¹æ ¼','åƒè€ƒé«˜é»','åƒè€ƒé«˜é»æ—¥æœŸ','è§¸ç™¼åƒ¹','åç›®éƒ¨ä½USD','å€‰ä½å‡åƒ¹','æŒå€‰åƒ¹å€¼USD','å‡ºå ´æ¯”ä¾‹','ROI_USDT','ROI_PCT','Realized_Gain','Cumulative_Profit'],
      ['type','date','price','ref_high','ref_high_date','trigger_price','notional_usd','avg_price','position_value_usd','exit_ratio_pct','roi_total_usdt','roi_total_pct','realized_gain_usd','cumulative_realized_usd']
    );
    downloadCSV('entries.csv', csv);
  }
  function exportSummaryCSV(){
    if(!lastRes) return;
    const r=lastRes;
    const csv=toCSV([{
      samples:lastData?.length||0,
      range:(lastData?.length? iso(lastData[0].date)+' â†’ '+iso(lastData[lastData.length-1].date):''),
      entries:r.nEntry, exits:r.nExit, liquidated:r.liquidated?'Y':'N',
      equity_end:r.equityEnd, roi_pct:r.roi*100, mdd_pct:r.mddPct, safety_end_pct:r.safetyEnd
    }], ['samples','range','entries','exits','liquidated','equity_end','roi_pct','mdd_pct','safety_end_pct'],
    ['samples','range','entries','exits','liquidated','equity_end','roi(%)','mdd(%)','safety_end(%)']);
    downloadCSV('summary.csv', csv);
  }

  function setupCollapsible(id) {
    const header = document.querySelector(`.collapsible-header[data-target="${id}"]`);
    const content = document.getElementById(id);
    if (!header || !content) return;
    setTimeout(() => { content.style.maxHeight = content.scrollHeight + 'px'; }, 50);
    header.addEventListener('click', () => {
      const isCollapsed = header.classList.contains('collapsed');
      header.classList.toggle('collapsed');
      if (isCollapsed) content.style.maxHeight = content.scrollHeight + 'px';
      else content.style.maxHeight = '0';
    });
  }

  $('#file').addEventListener('change', async (e)=>{
    const f=e.target.files&&e.target.files[0];
    if(!f){ uiLog('æ²’æœ‰æ”¶åˆ°æª”æ¡ˆ'); return; }
    uiLog(`æª”åï¼š${f.name}ï¼Œå¤§å°ï¼š${f.size}ï¼Œè®€å–ä¸­â€¦`);
    try{
      const rows=await readAnyTabular(f);
      uiLog('å·²è®€å– '+rows.length+' è¡Œï¼Œè§£æä¸­â€¦');
      df=parseRows(rows);
      uiLog('å·²è§£æ '+df.length+' ç­†ï¼ˆ'+iso(df[0].date)+' â†’ '+iso(df[df.length-1].date)+'ï¼‰ï¼Œè¨ˆç®—ä¸­â€¦');
      computeIfReady();
    }catch(err){ console.error(err); uiLog('éŒ¯èª¤ï¼š'+(err.message||err)); alert(err.message||err); }
  });

  let debounce=null;
  // âœ¨ MODIFIED: æ–°å¢ exitSecondPeakDrawdown çš„ç›£è½
  ['years','entryLookback','entryPullback','exitLookback','exitDrawdown','exitSecondPeakDrawdown','exitSellPct','lev','margin','lot','maxPerQ','maxExitPerQ','exitNonNegRoi','exitAboveAvgOnly','safetyFloor','safetyMode']
    .forEach(id=>{ document.getElementById(id).addEventListener('input',()=>{ clearTimeout(debounce); debounce=setTimeout(()=>{ if(df) computeIfReady(); refreshLiveDaily(); },150); }); });
  $('#exportEntries').addEventListener('click', exportEntriesCSV);
  $('#exportSummary').addEventListener('click', exportSummaryCSV);
  $('#exportChartPng').addEventListener('click', exportChartPng);

  async function initLive(){ await refreshLiveDaily(); startBinanceWS(); bindLiveAutoRefresh(); }

  document.addEventListener('DOMContentLoaded', () => {
    setupCollapsible('controlRisk');
    setupCollapsible('controlFund');
    initLive();
  });

  $('#entryLookback').addEventListener('change', refreshLiveDaily);
  $('#entryPullback').addEventListener('input', refreshLiveDaily);
  $('#exitLookback').addEventListener('change', refreshLiveDaily);
  $('#exitDrawdown').addEventListener('input', refreshLiveDaily);
  // âœ¨ NEW: ç›£è½æ¬¡é«˜å›è½åƒæ•¸ï¼Œä»¥æ›´æ–°å³æ™‚è§¸ç™¼åƒ¹
  $('#exitSecondPeakDrawdown').addEventListener('input', refreshLiveDaily); 
</script>
</body>
</html>
